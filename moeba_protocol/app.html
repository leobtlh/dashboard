
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mœba Protocol | App</title>

    <!-- FAVICON -->
    <link rel="icon" href="../img/IconMoeba.png" type="image/png">

    <!-- 1. Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Configuration Tailwind pour le Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark shade
                            950: '#020617',
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'zoom-in': 'zoomIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        zoomIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. Script d'initialisation du thème (Anti-FOUC) -->
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>

    <!-- 4. Chargement de React et ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>

    <!-- 5. Chargement de Prop-Types et Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>

    <!-- 6. Chargement de Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" xintegrity="sha512-FDcVY+g7vc55I8ZY0C0n8n7qoAVbFmnzz414JIqLuuqiCe3rMZQ52QB1tNRg7pDOcCS5jTKS23IGvBJq7V3Wbw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- 7. Chargement de Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* --- Cacher les flèches des inputs number --- */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 transition-colors duration-300">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Importation des composants Recharts depuis l'objet global window.Recharts
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};

        // --- CONSTANTES WEB3 ---
        const AVAILABLE_CHAINS = ['Base', 'Ethereum', 'Polygon', 'Arbitrum', 'Optimism'];
        const AVAILABLE_ASSETS = ['USDC', 'USDT', 'DAI', 'WETH'];

        // --- LOGOS BLOCKCHAINS ---
        const CHAIN_LOGOS = {
            'Base': 'https://avatars.githubusercontent.com/u/108554348?s=200&v=4',
            'Ethereum': 'https://cryptologos.cc/logos/ethereum-eth-logo.svg?v=026',
            'Polygon': 'https://cryptologos.cc/logos/polygon-matic-logo.svg?v=026',
            'Arbitrum': 'https://cryptologos.cc/logos/arbitrum-arb-logo.svg?v=026',
            'Optimism': 'https://cryptologos.cc/logos/optimism-ethereum-op-logo.svg?v=026'
        };

        // --- CONSTANTES LIVE MODE ---
        // Adresse fictive pour la démo, à remplacer par l'adresse déployée du HPIVFactory
        const FACTORY_ADDRESS_LIVE = "0x0000000000000000000000000000000000000000";

        // ABI pour vérifier le status Whitelist sur la Factory + Register
        const FACTORY_ABI_EXTENDED = [
            "function isWhitelistedInsurer(address insurer) view returns (bool)",
            "function registerInsurer(string companyName, string kybHash) external",
            "function insurerRequests(address insurer) view returns (string companyName, string kybHash, uint8 status, uint256 requestDate)"
        ];

        // --- WHITELIST ASSUREURS LOCALE (SIMULATION) ---
        const INSURER_WHITELIST_LOCAL = [
            '0x912f9886fb676750943fdefc4c30d3ca927c3a72',
            '0x5B757b308b8842698035C53b8ea0844240ac485B',
            '0xsimulated000000000000000000000000000000'
        ].map(addr => addr.toLowerCase());

        // ABI Minimal pour lire les balances ERC20
        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // Mapping partiel des adresses de tokens (Mainnets) pour la démo
        const TOKEN_MAP = {
            'Ethereum': {
                'USDC': '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                'USDT': '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                'DAI': '0x6B175474E89094C44Da98b954EedeAC495271d0F',
                'WETH': '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'
            },
            'Base': {
                'USDC': '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
                'WETH': '0x4200000000000000000000000000000000000006'
            },
            'Polygon': {
                'USDC': '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
                'USDT': '0xc2132D05D31c914a87C6611C10748AEb04B58e8F'
            },
            'Arbitrum': {
                'USDC': '0xaf88d065e77c8cC2239327C5EDb3A432268e5831'
            }
        };

        // --- COMPOSANTS ICONS ---
        const IconWrapper = ({ children, className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" strokeWidth="2"
            strokeLinecap="round" strokeLinejoin="round"
            className={className}
          >
            {children}
          </svg>
        );

        const Shield = ({ className }) => <IconWrapper className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>;
        const Wind = ({ className }) => <IconWrapper className={className}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Activity = ({ className }) => <IconWrapper className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Wallet = ({ className }) => <IconWrapper className={className}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconWrapper>;
        const AlertTriangle = ({ className }) => <IconWrapper className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>;
        const TrendingUp = ({ className }) => <IconWrapper className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
        const Lock = ({ className }) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
        const Plus = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const ArrowRight = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>;
        const ArrowLeft = ({ className }) => <IconWrapper className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>;
        const CheckCircle2 = ({ className }) => <IconWrapper className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></IconWrapper>;
        const Building2 = ({ className }) => <IconWrapper className={className}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconWrapper>;
        const Coins = ({ className }) => <IconWrapper className={className}><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>;
        const Info = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></IconWrapper>;
        const X = ({ className }) => <IconWrapper className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const LogOut = ({ className }) => <IconWrapper className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconWrapper>;
        const RefreshCw = ({ className }) => <IconWrapper className={className}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>;
        const Zap = ({ className }) => <IconWrapper className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>;
        const Globe = ({ className }) => (
            <IconWrapper className={className}>
                <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                >
                    <circle cx="12" cy="12" r="10" />
                    <path d="M2 12h20" />
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" style={{ display: 'none' }} />
                    <path d="M12 2v20" />
                    <path d="M12 2C6 2 6 22 12 22" />
                    <path d="M12 2C18 2 18 22 12 22" />
                </svg>
            </IconWrapper>
        );
        const UserCheck = ({ className }) => <IconWrapper className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></IconWrapper>;
        const Minimize2 = ({ className }) => <IconWrapper className={className}><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></IconWrapper>;
        const LayoutGrid = ({ className }) => <IconWrapper className={className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></IconWrapper>;
        const List = ({ className }) => <IconWrapper className={className}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>;
        const ChevronDown = ({ className }) => <IconWrapper className={className}><polyline points="6 9 12 15 18 9"/></IconWrapper>;
        const Search = ({ className }) => <IconWrapper className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconWrapper>;
        const Calendar = ({ className }) => <IconWrapper className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconWrapper>;


        // Icônes Wallet Spécifiques
        const RabbyIcon = () => (
            <img
                src="https://github.com/RabbyHub.png"
                alt="Rabby Wallet"
                className="w-8 h-8 rounded-lg shadow-sm bg-white"
            />
        );
        const ZerionIcon = () => (
            <img
                src="https://github.com/zeriontech.png"
                alt="Zerion Wallet"
                className="w-8 h-8 rounded-lg shadow-sm bg-white"
            />
        );
        const MetaMaskIcon = () => (
            <img
                src="https://github.com/MetaMask.png"
                alt="MetaMask"
                className="w-8 h-8 rounded-lg shadow-sm bg-white"
            />
        );
        const WalletConnectIcon = () => (
             <img
                src="https://github.com/WalletConnect.png"
                alt="WalletConnect"
                className="w-8 h-8 rounded-lg shadow-sm bg-white"
            />
        );
        const SimulationIcon = () => (
             <svg viewBox="0 0 32 32" className="w-8 h-8 rounded-lg" fill="none">
                <rect width="32" height="32" rx="8" fill="#475569"/>
                <path d="M16 6v20M6 16h20" stroke="white" strokeWidth="4" strokeLinecap="round"/>
             </svg>
        );


        // Icônes Thème
        const Sun = ({ className }) => (
            <IconWrapper className={className}>
                <circle cx="12" cy="12" r="4" />
                <path d="M12 2v2" />
                <path d="M12 20v2" />
                <path d="m4.93 4.93 1.41 1.41" />
                <path d="m17.66 17.66 1.41 1.41" />
                <path d="M2 12h2" />
                <path d="M20 12h2" />
                <path d="m6.34 17.66-1.41 1.41" />
                <path d="m19.07 4.93-1.41 1.41" />
            </IconWrapper>
            );
        const Moon = ({ className }) => <IconWrapper className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></IconWrapper>;

        // --- COMPOSANT NOTIFICATION ---
        const NotificationToast = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgClass = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-600' : 'bg-slate-800 dark:bg-slate-700';
            const icon = type === 'error' ? <AlertTriangle className="h-5 w-5" /> : <CheckCircle2 className="h-5 w-5" />;

            return (
                <div className={`fixed bottom-6 right-6 z-[100] ${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-up flex items-center gap-4 max-w-md`}>
                    <div className="shrink-0">{icon}</div>
                    <div className="flex-1 text-sm font-medium">{message}</div>
                    <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full transition-colors">
                        <X className="h-4 w-4" />
                    </button>
                </div>
            );
        };

        // --- GÉNÉRATEUR DE DONNÉES HISTORIQUES, SIMULATION (MOCK ORACLE) ---
        const generateMockHistory = (type) => {
            const data = [];
            const now = new Date();
            for (let i = 30; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dayStr = date.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit' });
                let risk, trigger1;
                if (type === 'WIND') {
                    risk = Math.min(99, Math.max(0, 5 + (i * 0.2) + (Math.random() * 10 - 5)));
                    trigger1 = Math.min(300, Math.max(0, 50 + (i * 1.5) + (Math.random() * 80 - 20)));
                    data.push({ date: dayStr, risk: risk.toFixed(1), windSpeed: trigger1.toFixed(0) });
                } else {
                    risk = Math.min(99, Math.max(0, 2 + (Math.random() * 5)));
                    if (i === 5) risk = 45;
                    trigger1 = Math.max(0, (Math.random() * 4).toFixed(1));
                    if (i === 5) trigger1 = 6.8;
                    data.push({ date: dayStr, risk: risk.toFixed(1), magnitude: trigger1 });
                }
            }
            return data;
        };

        // --- PARSER LES DATES (standard anglais) ---
        const parseAppDate = (dateStr) => {
            // Gestion des cas vides ou "Pending"
            if (!dateStr || dateStr === "Pending" || dateStr === "En attente") return null;

            const parsedDate = new Date(dateStr);

            // Sécurité : si la date est invalide (ex: "32 Foo 2025"), on retourne null
            return isNaN(parsedDate.getTime()) ? null : parsedDate;
        };

        // --- CALCUL DES JOURS RESTANTS ---
        const calculateDaysRemaining = (dateStr) => {
            const targetDate = parseAppDate(dateStr);
            if (!targetDate) return 0;
            const today = new Date();
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        };

        // --- DONNÉES MOCK AVEC CHAINES ET ASSETS ---
        const INITIAL_VAULTS = [
            {
                id: '0x8f2a...e12b',
                name: 'Atlantic Hurricane 2025',
                description: 'Parametric coverage against category 4+ hurricanes in Florida. Triggered if wind speed exceeds 210 km/h at NOAA certified stations.',
                insurer: 'Axa Climate',
                totalCapacity: 10000000,
                claimAmount: 10000000,
                currentAssets: 10000000,
                juniorCapital: 1000000,
                premium: 800000,
                startDate: '01 January 2025',
                maturityDate: '31 December 2025',
                apr: '12.50',
                riskProb: '5.2',
                status: 'MATURED',
                chain: 'Ethereum',
                asset: 'USDC',
                userBalance: 5000,
                balances: { '0x...': 5000 },
                balancesJunior: {},
                balancesSenior: { '0x...': 5000 },
                totalJuniorDeposits: 0,
                totalSeniorDeposits: 8200000,
                triggers: [
                    { id: 'windSpeed', name: 'Wind', unit: 'km/h', color: '#8884d8' }
                ],
                history: [
                    { date: '01/08', risk: 10, windSpeed: 45 },
                    { date: '15/09', risk: 45, windSpeed: 160 },
                    { date: '30/10', risk: 5, windSpeed: 60 }
                ]
            },
            {
                id: '0x3c4d...9a12',
                name: 'California Quake 2026',
                description: 'Protection against earthquakes > 7.0 Richter in Southern California. USGS Oracle with Chainlink redundancy. Subscription period open.',
                insurer: 'Munich Re',
                totalCapacity: 5000000,
                claimAmount: 5000000,
                currentAssets: 1500000,
                juniorCapital: 500000,
                premium: 450000,
                startDate: '01 January 2026',
                maturityDate: '31 March 2026',
                apr: '8.75',
                riskProb: '3.1',
                status: 'OPEN',
                chain: 'Base',
                asset: 'USDC',
                userBalance: 0,
                balances: {},
                balancesJunior: {},
                balancesSenior: {},
                totalJuniorDeposits: 0,
                totalSeniorDeposits: 550000,
                triggers: [
                    { id: 'magnitude', name: 'Magnitude', unit: 'R', color: '#82ca9d' }
                ],
                history: [
                    { date: '01/01', risk: 1.5, magnitude: 2.1 },
                    { date: '05/01', risk: 1.8, magnitude: 2.4 },
                    { date: '10/01', risk: 1.2, magnitude: 1.9 }
                ]
            }
        ];

        const MONTHS = [
            { name: 'January', days: 31 }, { name: 'February', days: 29 }, { name: 'March', days: 31 },
            { name: 'April', days: 30 }, { name: 'May', days: 31 }, { name: 'June', days: 30 },
            { name: 'July', days: 31 }, { name: 'August', days: 31 }, { name: 'September', days: 30 },
            { name: 'October', days: 31 }, { name: 'November', days: 30 }, { name: 'December', days: 31 }
        ];

        // --- VALIDATION JOURS DANS MOIS ---
        const isValidDayInMonth = (day, monthName, year) => {
            const mIndex = MONTHS.findIndex(m => m.name === monthName);
            if (mIndex === -1) return false;
            // new Date(year, monthIndex + 1, 0) donne le dernier jour du mois
            const daysInMonth = new Date(year, mIndex + 1, 0).getDate();
            return day > 0 && day <= daysInMonth;
        };

        // --- COMPOSANT GRAPHIQUE ---
        const RiskChart = ({ data, triggers }) => {
            const [activeTriggers, setActiveTriggers] = useState([]);
            if (!LineChart) return <div className="p-4 bg-red-50 text-red-600 rounded">Chart loading error</div>;

            const toggleTrigger = (triggerId) => {
                if (activeTriggers.includes(triggerId)) {
                    setActiveTriggers(activeTriggers.filter(id => id !== triggerId));
                } else {
                    setActiveTriggers([...activeTriggers, triggerId]);
                }
            };

            return (
                <div className="space-y-4">
                    <div className="flex flex-wrap items-center gap-4 mb-2">
                        <div className="flex items-center gap-2">
                            <span className="w-3 h-3 rounded-full bg-orange-500"></span>
                            <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Risk Probability (%)</span>
                        </div>
                        {triggers.map(trigger => (
                            <label key={trigger.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 p-1 rounded-lg transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                                <input
                                    type="checkbox"
                                    checked={activeTriggers.includes(trigger.id)}
                                    onChange={() => toggleTrigger(trigger.id)}
                                    className="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-slate-600 dark:bg-slate-900"
                                />
                                <span className="text-sm text-slate-600 dark:text-slate-400" style={{ color: activeTriggers.includes(trigger.id) ? trigger.color : undefined }}>
                                    {trigger.name} ({trigger.unit})
                                </span>
                            </label>
                        ))}
                    </div>

                    <div className="h-[300px] w-full bg-slate-50 dark:bg-slate-900/30 rounded-xl p-2 border border-slate-100 dark:border-slate-700">
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={data} margin={{ top: 5, right: 30, left: 0, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} className="dark:opacity-10" />
                                <XAxis dataKey="date" tick={{fontSize: 12, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                                <YAxis yAxisId="left" tick={{fontSize: 12, fill: '#f97316'}} axisLine={false} tickLine={false} unit="%" domain={[0, 100]} />
                                <YAxis yAxisId="right" orientation="right" tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false} hide={activeTriggers.length === 0} />
                                <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)', backgroundColor: 'rgba(255, 255, 255, 0.9)' }} labelStyle={{ color: '#0f172a', fontWeight: 'bold' }} />
                                <Legend wrapperStyle={{ paddingTop: '10px' }}/>
                                <Line yAxisId="left" type="monotone" dataKey="risk" name="Claim Probability" stroke="#f97316" strokeWidth={3} dot={false} activeDot={{ r: 6 }} />
                                {triggers.map(trigger => (
                                    activeTriggers.includes(trigger.id) && (
                                        <Line key={trigger.id} yAxisId="right" type="monotone" dataKey={trigger.id} name={`${trigger.name} (${trigger.unit})`} stroke={trigger.color} strokeWidth={2} dot={false} strokeDasharray="5 5" />
                                    )
                                ))}
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT FORMULAIRE ENREGISTREMENT ASSUREUR ---
        const InsurerRegistrationModal = ({ isOpen, onClose, onSubmit, isSubmitting }) => {
            const [formData, setFormData] = useState({ companyName: '', kybLink: '' });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-200 dark:border-slate-700 overflow-hidden animate-zoom-in" onClick={e => e.stopPropagation()}>
                         <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-900 dark:text-white flex items-center gap-2">
                                <Shield className="h-5 w-5 text-indigo-600" /> Insurer Registration
                            </h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                                <X className="h-5 w-5 text-slate-500" />
                            </button>
                        </div>
                        <div className="p-6">
                            <div className="mb-6 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800/50 text-sm text-indigo-800 dark:text-indigo-300">
                                To be whitelisted, you must provide legal proof of existence (KYB) and a valid insurance certificate.
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Company Name</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.companyName}
                                        onChange={e => setFormData({...formData, companyName: e.target.value})}
                                        className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="Ex: Axa Corporate Solutions"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">KYB Proof (IPFS/URL Link)</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.kybLink}
                                        onChange={e => setFormData({...formData, kybLink: e.target.value})}
                                        className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm"
                                        placeholder="ipfs://..."
                                    />
                                    <p className="text-xs text-slate-500 mt-1">Link to the decentralized hosted certificate.</p>
                                </div>
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSubmitting ? "Sending request..." : "Submit Request"}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT FORMULAIRE KYC INVESTISSEUR ---
        const InvestorKYCModal = ({ isOpen, onClose, onSubmit, isSubmitting }) => {
            const [formData, setFormData] = useState({ fullName: '', email: '', idHash: '' });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-200 dark:border-slate-700 overflow-hidden animate-zoom-in" onClick={e => e.stopPropagation()}>
                         <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-900 dark:text-white flex items-center gap-2">
                                <UserCheck className="h-5 w-5 text-blue-600" /> Investor KYC (FinSA)
                            </h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                                <X className="h-5 w-5 text-slate-500" />
                            </button>
                        </div>
                        <div className="p-6">
                            <div className="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800/50 text-sm text-blue-800 dark:text-blue-300">
                                To deposit into compliant Vaults, you must verify your identity (Qualified Investor Check).
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Full Legal Name</label>
                                    <input
                                        type="text" required
                                        value={formData.fullName}
                                        onChange={e => setFormData({...formData, fullName: e.target.value})}
                                        className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="John Doe"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Email (Compliance)</label>
                                    <input
                                        type="email" required
                                        value={formData.email}
                                        onChange={e => setFormData({...formData, email: e.target.value})}
                                        className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="john@example.com"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">ID/Passport Hash</label>
                                    <input
                                        type="text" required
                                        value={formData.idHash}
                                        onChange={e => setFormData({...formData, idHash: e.target.value})}
                                        className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                                        placeholder="0x..."
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none transition-all flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSubmitting ? "Verifying..." : "Verify & Authorize Wallet"}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP COMPONENT ---
        function App() {
          const [activeRole, setActiveRole] = useState('investor');
          const [walletConnected, setWalletConnected] = useState(false);
          const [userAddress, setUserAddress] = useState('');
          const [userFullAddress, setUserFullAddress] = useState('');
          const [userBalance, setUserBalance] = useState('0.00'); // Solde NATIF (ETH)

          // WALLET SELECTOR MODAL STATE
          const [showWalletSelector, setShowWalletSelector] = useState(false);
          const [showOtherWallets, setShowOtherWallets] = useState(false);

          // INSURER REGISTRATION MODAL
          const [showInsurerRegistration, setShowInsurerRegistration] = useState(false);
          const [isRegistering, setIsRegistering] = useState(false);
          const [registrationStatus, setRegistrationStatus] = useState('none');

          // État pour le solde du token spécifique au vault sélectionné
          const [assetBalance, setAssetBalance] = useState(0);
          const [assetBalanceFormatted, setAssetBalanceFormatted] = useState('0.00');

          // Initialisation des vaults
          const [vaults, setVaults] = useState(() => {
              const saved = localStorage.getItem('moeba_vaults');
              return saved ? JSON.parse(saved) : INITIAL_VAULTS;
          });

          useEffect(() => {
              localStorage.setItem('moeba_vaults', JSON.stringify(vaults));
          }, [vaults]);

          const [selectedVault, setSelectedVault] = useState(null);
          const [depositAmount, setDepositAmount] = useState('');
          // STATES POUR LE RETRAIT
          const [withdrawAmount, setWithdrawAmount] = useState('');
          const [actionTab, setActionTab] = useState('deposit'); // 'deposit' | 'withdraw'
          // STATE TRANCHE (Senior vs Junior)
          const [trancheType, setTrancheType] = useState('senior');

          // FILTRES & TRI
          const [selectedChains, setSelectedChains] = useState([]);
          const [searchQuery, setSearchQuery] = useState('');
          const [aprSort, setAprSort] = useState('neutral');
          const [maturitySort, setMaturitySort] = useState('neutral');
          const [riskSort, setRiskSort] = useState('neutral');

          // --- MODE LISTE / GRILLE ---
          const [viewMode, setViewMode] = useState('list');

          // --- MODE LIVE VS SIMULATION ---
          const [isLiveMode, setIsLiveMode] = useState(false);

          // STATUS WHITELIST & KYC
          const [isInsurerWhitelisted, setIsInsurerWhitelisted] = useState(false);
          const [isInvestorWhitelisted, setIsInvestorWhitelisted] = useState(false);
          const [showInvestorKYC, setShowInvestorKYC] = useState(false);
          const [isInvestorRegistering, setIsInvestorRegistering] = useState(false);

          // STATUS EXPANSION FORMULAIRE
          const [isFormExpanded, setIsFormExpanded] = useState(false);

          const [isDarkMode, setIsDarkMode] = useState(false);
          const [notification, setNotification] = useState({ message: '', type: 'info' });

          const [showWalletMenu, setShowWalletMenu] = useState(false);

          const showNotification = (msg, type = 'info') => {
              setNotification({ message: msg, type });
              setTimeout(() => {
                  setNotification(prev => prev.message === msg ? { message: '', type: 'info' } : prev);
              }, 4000);
          };

          // --- LOGIQUE DE VÉRIFICATION WHITELIST & STATUS ---
          useEffect(() => {
              const checkWhitelistStatus = async () => {
                  if (!walletConnected || !userFullAddress) {
                      setIsInsurerWhitelisted(false);
                      setIsInvestorWhitelisted(false);
                      setRegistrationStatus('none');
                      return;
                  }

                  // ADRESSE DE SIMULATION
                  const SIMULATION_ADDRESS = '0xsimulated000000000000000000000000000000';

                  // VERIFICATION INVESTISSEUR
                  const investorList = JSON.parse(localStorage.getItem('moeba_investor_whitelist') || '[]');
                  const investorRequests = JSON.parse(localStorage.getItem('moeba_investor_requests') || '[]');

                  // Vérification du statut de la demande KYC pour cet utilisateur
                  const myKycRequest = investorRequests.find(r => r.address.toLowerCase() === userFullAddress.toLowerCase());
                  const isPendingKyc = myKycRequest && myKycRequest.status === 1;

                  // Wallet de simulation OU whitelist officielle
                  if (userFullAddress.toLowerCase() === SIMULATION_ADDRESS || investorList.includes(userFullAddress.toLowerCase())) {
                      setIsInvestorWhitelisted(true);
                  } else {
                      setIsInvestorWhitelisted(false);
                      // si isPendingKyc est vrai, l'utilisateur est connu mais pas encore approuvé.
                  }

                  // VERIFICATION ASSUREUR
                  if (isLiveMode) {
                      try {
                          const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                          if (FACTORY_ADDRESS_LIVE === "0x0000000000000000000000000000000000000000") {
                              setIsInsurerWhitelisted(false);
                              return;
                          }
                          const factoryContract = new window.ethers.Contract(FACTORY_ADDRESS_LIVE, FACTORY_ABI_EXTENDED, provider);
                          const isWhitelisted = await factoryContract.isWhitelistedInsurer(userFullAddress);
                          setIsInsurerWhitelisted(isWhitelisted);
                          if (!isWhitelisted) {
                              try {
                                const request = await factoryContract.insurerRequests(userFullAddress);
                                if (request.status === 1) setRegistrationStatus('pending');
                                else if (request.status === 3) setRegistrationStatus('rejected');
                                else setRegistrationStatus('none');
                              } catch(e) {}
                          }
                      } catch (error) {
                          console.error("Erreur vérification Whitelist On-Chain:", error);
                          setIsInsurerWhitelisted(false);
                      }
                  } else {
                      const isLocalListed = INSURER_WHITELIST_LOCAL.includes(userFullAddress.toLowerCase());

                      if (isLocalListed) {
                          setIsInsurerWhitelisted(true);
                      } else {
                          const storedRequests = localStorage.getItem('moeba_insurer_requests');
                          if (storedRequests) {
                              try {
                                  const requests = JSON.parse(storedRequests);
                                  const myRequest = requests.find(r => r.address.toLowerCase() === userFullAddress.toLowerCase());
                                  if (myRequest) {
                                      if (myRequest.status === 2) {
                                           setIsInsurerWhitelisted(true);
                                           setRegistrationStatus('approved');
                                      } else if (myRequest.status === 1) {
                                           setIsInsurerWhitelisted(false);
                                           setRegistrationStatus('pending');
                                      } else if (myRequest.status === 3) {
                                           setIsInsurerWhitelisted(false);
                                           setRegistrationStatus('rejected');
                                      }
                                  } else {
                                      setIsInsurerWhitelisted(false);
                                      setRegistrationStatus('none');
                                  }
                              } catch(e) {}
                          } else {
                              setIsInsurerWhitelisted(false);
                              setRegistrationStatus('none');
                          }
                      }
                  }
              };
              checkWhitelistStatus();
          }, [walletConnected, userFullAddress, isLiveMode]);

          // --- RECUPERATION DU SOLDE TOKEN SPECIFIQUE ---
          useEffect(() => {
            const fetchAssetBalance = async () => {
                if (!walletConnected || !selectedVault || !window.ethereum) {
                    setAssetBalance(0);
                    setAssetBalanceFormatted('0.00');
                    return;
                }
                try {
                    const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                    const assetSymbol = selectedVault.asset;
                    const chainName = selectedVault.chain;
                    const tokenAddress = TOKEN_MAP[chainName] ? TOKEN_MAP[chainName][assetSymbol] : null;

                    let balance = window.ethers.BigNumber.from(0);
                    let decimals = 18;

                    if (tokenAddress) {
                        const contract = new window.ethers.Contract(tokenAddress, ERC20_ABI, provider);
                        balance = await contract.balanceOf(userFullAddress);
                        try { decimals = await contract.decimals(); } catch(e) {}
                    } else if (assetSymbol === 'ETH' && chainName === 'Ethereum') {
                        balance = await provider.getBalance(userFullAddress);
                    }
                    const formatted = window.ethers.utils.formatUnits(balance, decimals);
                    setAssetBalance(parseFloat(formatted));
                    setAssetBalanceFormatted(parseFloat(formatted).toFixed(4));
                } catch (err) {
                    setAssetBalance(0);
                    setAssetBalanceFormatted('0.0000');
                }
            };
            fetchAssetBalance();
          }, [selectedVault, walletConnected, userFullAddress]);

          // --- EFFET CHANGEMENT COMPTE : MAJ MULTI-WALLET ---
          useEffect(() => {
              setVaults(prevVaults => prevVaults.map(v => {
                  const bals = v.balances || {};
                  // Si un wallet est connecté, on cherche son solde, sinon 0
                  const specificBalance = userFullAddress ? (bals[userFullAddress] || 0) : 0;

                  if (v.userBalance !== specificBalance) {
                      return { ...v, userBalance: specificBalance };
                  }
                  return v;
              }));
          }, [userFullAddress]);

          // --- SYNC SELECTED VAULT ---
          useEffect(() => {
              if (selectedVault) {
                  const current = vaults.find(v => v.id === selectedVault.id);
                  // Update only if relevant data changed
                  if (current && (current.userBalance !== selectedVault.userBalance || current.status !== selectedVault.status || current.currentAssets !== selectedVault.currentAssets)) {
                      setSelectedVault(current);
                  }
              }
          }, [vaults, selectedVault]);

          useEffect(() => {
            const isDark = document.documentElement.classList.contains('dark');
            setIsDarkMode(isDark);
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        const addr = accounts[0];
                        setUserFullAddress(addr);
                        setUserAddress(`${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`);
                        showNotification("Account change detected", 'info');
                    } else {
                        setWalletConnected(false);
                        setUserAddress('');
                        setUserFullAddress('');
                        showNotification("Wallet disconnected", 'info');
                    }
                });
            }
          }, []);

          const toggleTheme = () => {
            if (isDarkMode) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                setIsDarkMode(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                setIsDarkMode(true);
            }
          };

          const [newVaultData, setNewVaultData] = useState({
            name: '',
            description: '',
            cap: 40000000,
            coverage: 40000000,
            juniorPercent: 10,
            junior: 4000000,
            premium: 330000,
            // START DATE FIELDS (De app.html)
            startDay: '',
            startMonth: 'January',
            startYear: new Date().getFullYear(),
            // MATURITY FIELDS
            day: '',
            month: 'January',
            year: new Date().getFullYear(),
            chain: 'Base',
            asset: 'USDC'
          });

          const [isOvercollateralized, setIsOvercollateralized] = useState(false);

          // --- GESTION DES FILTRES INVESTISSEUR ---
          const toggleChainFilter = (chain) => {
              if (selectedChains.includes(chain)) {
                  setSelectedChains(selectedChains.filter(c => c !== chain));
              } else {
                  setSelectedChains([...selectedChains, chain]);
              }
          };

          const parseDateForSort = (dateStr) => {
              if (!dateStr || dateStr === "Pending") return new Date(9999, 11, 31);
              const d = parseAppDate(dateStr);
              return d || new Date();
          };

          const filteredVaults = vaults.filter(vault => {
              if (selectedChains.length > 0 && !selectedChains.includes(vault.chain)) return false;
              if (searchQuery) {
                  const q = searchQuery.toLowerCase();
                  return vault.asset.toLowerCase().includes(q) || vault.name.toLowerCase().includes(q);
              }
              return true;
          }).sort((a, b) => {
              if (aprSort !== 'neutral') {
                  const valA = parseFloat(a.apr);
                  const valB = parseFloat(b.apr);
                  return aprSort === 'desc' ? valB - valA : valA - valB;
              }
              if (maturitySort !== 'neutral') {
                  const dateA = parseDateForSort(a.maturityDate);
                  const dateB = parseDateForSort(b.maturityDate);
                  return maturitySort === 'asc' ? dateA - dateB : dateB - dateA;
              }
              if (riskSort !== 'neutral') {
                  const riskA = parseFloat(a.riskProb);
                  const riskB = parseFloat(b.riskProb);
                  return riskSort === 'asc' ? riskA - riskB : riskB - riskA;
              }
              return 0;
          });

          const toggleAprSort = () => {
              setMaturitySort('neutral');
              setRiskSort('neutral');
              if (aprSort === 'neutral') setAprSort('desc');
              else if (aprSort === 'desc') setAprSort('asc');
              else setAprSort('neutral');
          };

          const toggleMaturitySort = () => {
              setAprSort('neutral');
              setRiskSort('neutral');
              if (maturitySort === 'neutral') setMaturitySort('asc');
              else if (maturitySort === 'asc') setMaturitySort('desc');
              else setMaturitySort('neutral');
          };

          const toggleRiskSort = () => {
              setAprSort('neutral');
              setMaturitySort('neutral');
              if (riskSort === 'neutral') setRiskSort('asc');
              else if (riskSort === 'asc') setRiskSort('desc');
              else setRiskSort('neutral');
          };

          // --- CONNEXION WALLET ---
          const openWalletSelector = () => {
             setShowWalletSelector(true);
             setShowOtherWallets(false);
          };

          const handleWalletSelect = async (walletType) => {
             setShowWalletSelector(false);

             // --- SIMULATION WALLET ---
             if (walletType === 'simulation') {
                 const simAddress = '0xsimulated000000000000000000000000000000';
                 setWalletConnected(true);
                 setUserAddress('Simu...Test');
                 setUserFullAddress(simAddress);
                 setUserBalance('100.0000');
                 showNotification("Connected with Simulation Wallet (Test Mode)", 'success');
                 return;
             }

             if (!window.ethers) { showNotification("Technical error: Web3 library not loaded.", 'error'); return; }
             let providerInput = null;
             if (walletType === 'zerion') {
                 if (window.zerionWallet) providerInput = window.zerionWallet;
                 else if (window.ethereum && window.ethereum.isZerion) providerInput = window.ethereum;
                 else providerInput = window.ethereum;
             } else if (walletType === 'rabby') {
                 if (window.ethereum && window.ethereum.isRabby) providerInput = window.ethereum;
                 else providerInput = window.ethereum;
             } else if (walletType === 'metamask') {
                 if (window.ethereum) providerInput = window.ethereum;
             } else if (walletType === 'walletconnect') {
                 if (window.ethereum) providerInput = window.ethereum;
             } else {
                 providerInput = window.ethereum;
             }
             if (!providerInput) { showNotification("No compatible wallet detected.", 'error'); return; }

             try {
                  const accounts = await providerInput.request({ method: 'eth_requestAccounts' });
                  if (!accounts || accounts.length === 0) { showNotification("No account selected.", 'error'); return; }
                  const provider = new window.ethers.providers.Web3Provider(providerInput);
                  const signer = provider.getSigner();
                  const address = await signer.getAddress();
                  try {
                      const messageToSign = `Mœba Protocol Login\n\nWallet: ${address}\nNonce: ${Date.now()}`;
                      showNotification("Please sign the request in your wallet...", 'info');
                      await signer.signMessage(messageToSign);
                      showNotification("Valid signature. Authorized login.", 'success');
                  } catch (signErr) {
                      console.error("Signature error:", signErr);
                      showNotification("Connection canceled: Signature rejected by user.", 'error');
                      return;
                  }
                  const balanceBig = await provider.getBalance(address);
                  const balanceFmt = window.ethers.utils.formatEther(balanceBig);
                  const shortAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                  setWalletConnected(true);
                  setUserAddress(shortAddress);
                  setUserFullAddress(address);
                  setUserBalance(parseFloat(balanceFmt).toFixed(4));
                  let walletName = 'Wallet';
                  if (walletType === 'zerion' || providerInput.isZerion || window.zerionWallet) walletName = 'Zerion';
                  else if (walletType === 'rabby' || providerInput.isRabby) walletName = 'Rabby';
                  else if (walletType === 'metamask' || providerInput.isMetaMask) walletName = 'MetaMask';
                  showNotification(`Connected with ${walletName}`, 'success');
             } catch (error) {
                  showNotification(`Connection failed: ${error.message || error}`, 'error');
             }
          };

          const disconnectWallet = () => {
             setWalletConnected(false);
             setUserAddress('');
             setUserFullAddress('');
             setUserBalance('0.00');
             setRegistrationStatus('none');
             showNotification("Disconnected from the application.", 'info');
          };

          // --- GESTION ENREGISTREMENT ASSUREUR (KYB) ---
          const handleInsurerRegistration = async (data) => {
              setIsRegistering(true);
              if (isLiveMode) {
                  try {
                      const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                      const signer = provider.getSigner();
                      const factoryContract = new window.ethers.Contract(FACTORY_ADDRESS_LIVE, FACTORY_ABI_EXTENDED, signer);
                      const tx = await factoryContract.registerInsurer(data.companyName, data.kybLink);
                      await tx.wait();
                      setRegistrationStatus('pending');
                      setShowInsurerRegistration(false);
                      showNotification("Registration request successfully submitted!", 'success');
                  } catch (err) {
                      showNotification("Blockchain Error: " + (err.reason || err.message), 'error');
                  }
              } else {
                  await new Promise(resolve => setTimeout(resolve, 1500));
                  const existing = localStorage.getItem('moeba_insurer_requests');
                  let requests = [];
                  if (existing) { try { requests = JSON.parse(existing); } catch(e) {} }
                  const newRequest = {
                      address: userFullAddress,
                      companyName: data.companyName,
                      kybHash: data.kybLink,
                      status: 1, // 1 = Pending
                      date: Date.now()
                  };
                  const existingIndex = requests.findIndex(r => r.address.toLowerCase() === userFullAddress.toLowerCase());
                  if (existingIndex >= 0) requests[existingIndex] = newRequest;
                  else requests.push(newRequest);
                  localStorage.setItem('moeba_insurer_requests', JSON.stringify(requests));
                  setRegistrationStatus('pending');
                  setShowInsurerRegistration(false);
                  showNotification("Simulated request sent successfully (Stored Locally)", 'success');
              }
              setIsRegistering(false);
          };

          // --- GESTION ENREGISTREMENT INVESTISSEUR (KYC) ---
          const handleInvestorKYC = async (data) => {
              setIsInvestorRegistering(true);
              await new Promise(resolve => setTimeout(resolve, 1500)); // Simulation à enlever

              // 1. Création de l'objet de demande (Status 1 = PENDING)
              const newRequest = {
                  address: userFullAddress,
                  fullName: data.fullName,
                  email: data.email,
                  idHash: data.idHash,
                  status: 1, // 1: En attente, 2: Approuvé, 3: Rejeté
                  date: Date.now()
              };

              // 2. Sauvegarde dans 'moeba_investor_requests' pour le Backoffice
              const storedRequests = JSON.parse(localStorage.getItem('moeba_investor_requests') || '[]');

              // Si une demande existe déjà,on la met à jour, sinon on ajoute
              const existingIndex = storedRequests.findIndex(r => r.address.toLowerCase() === userFullAddress.toLowerCase());
              if (existingIndex >= 0) {
                  storedRequests[existingIndex] = newRequest;
              } else {
                  storedRequests.push(newRequest);
              }

              localStorage.setItem('moeba_investor_requests', JSON.stringify(storedRequests));

              // 3. Feedback UI
              setShowInvestorKYC(false);
              setIsInvestorRegistering(false);

              // On ne met pas setIsInvestorWhitelisted(true) ici.
              // L'utilisateur doit attendre la validation dans le backoffice.
              showNotification("KYC Request sent to Admin. Please wait for approval.", 'info');
          };

          const updateJunior = (cap, percent) => {
             const calculatedJunior = (parseFloat(cap || 0) * parseFloat(percent || 0)) / 100;
             return calculatedJunior;
          };

          const getMaxDays = (monthName) => {
              const m = MONTHS.find(mo => mo.name === monthName);
              return m ? m.days : 31;
          };

          const handleDateBlur = () => {
                setNewVaultData(current => {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const currentYear = today.getFullYear();

                    const getValidDateObj = (d, mName, y) => {
                         const mIndex = MONTHS.findIndex(m => m.name === mName);
                         const safeY = Math.max(parseInt(y) || currentYear, currentYear);
                         const daysInMonth = new Date(safeY, mIndex + 1, 0).getDate();
                         const safeD = Math.min(Math.max(1, parseInt(d) || 1), daysInMonth);
                         return new Date(safeY, mIndex, safeD);
                    };

                    // Calcul Date Début
                    let sDate = getValidDateObj(current.startDay, current.startMonth, current.startYear);

                    // Si date passée (ex: 12 < 16), on passe au mois suivant (12 Février)
                    if (sDate < today) {
                        const targetDay = sDate.getDate();
                        let nextM = sDate.getMonth() + 1;
                        let nextY = sDate.getFullYear();

                        // Gestion changement année (Décembre -> Janvier)
                        if (nextM > 11) {
                            nextM = 0;
                            nextY++;
                        }

                        // Vérification validité jour dans le nouveau mois (ex: 31 Jan -> 28 Fév)
                        const daysInNextMonth = new Date(nextY, nextM + 1, 0).getDate();
                        const safeNextDay = Math.min(targetDay, daysInNextMonth);

                        sDate = new Date(nextY, nextM, safeNextDay);
                    }

                    // Sécurité: Si après projection c'est toujours <= aujourd'hui, on force demain
                    if (sDate <= today) {
                        sDate = new Date(today);
                        sDate.setDate(today.getDate() + 1);
                    }

                    // Calcul Date Fin
                    let eDate = getValidDateObj(current.day, current.month, current.year);

                    // Si on est le même mois/année que le début, mais que le jour de fin est inférieur au jour de début
                    if (
                        eDate.getMonth() === sDate.getMonth() &&
                        eDate.getFullYear() === sDate.getFullYear() &&
                        eDate.getDate() < sDate.getDate()
                    ) {
                        // On ajoute 1 mois à la date de fin
                        eDate.setMonth(eDate.getMonth() + 1);
                    }

                    // Si la fin est <= au début, on force Fin = Début + 1 jour
                    if (eDate <= sDate) {
                        eDate = new Date(sDate);
                        eDate.setDate(sDate.getDate() + 1);
                    }

                    return {
                        ...current,
                        startDay: sDate.getDate(),
                        startMonth: MONTHS[sDate.getMonth()].name,
                        startYear: sDate.getFullYear(),
                        day: eDate.getDate(),
                        month: MONTHS[eDate.getMonth()].name,
                        year: eDate.getFullYear()
                    };
                });
          };

          const handleCapBlur = () => {
                setNewVaultData(prev => {
                    let val = parseFloat(prev.cap);
                    if (isNaN(val) || val <= 0) val = 1000;
                    // Recalcule de junior qui dépend de la capacité
                    const updatedJunior = updateJunior(val, prev.juniorPercent);
                    return { ...prev, cap: val, junior: updatedJunior };
                });
          };

          // --- CREATION VAULT ---
          const handleCreateVault = async (e) => {
              e.preventDefault();

              // Validation finale silencieuse
              let capVal = parseFloat(newVaultData.cap);
              if (isNaN(capVal) || capVal <= 0) capVal = 1000;
              let premiumVal = parseFloat(newVaultData.premium) || 0;
              if (premiumVal < 0) premiumVal = 0;
              let claimVal = isOvercollateralized ? (parseFloat(newVaultData.coverage) || capVal) : capVal;

              // Description
              const finalDescription = newVaultData.description && newVaultData.description.trim() !== ""
                  ? newVaultData.description
                  : "Parametric Protection (auto-generated)";

              // Dates Finales
              const today = new Date(); today.setHours(0,0,0,0);
              const currentYear = today.getFullYear();
              const mIndexStart = MONTHS.findIndex(m => m.name === newVaultData.startMonth);
              const safeYStart = Math.max(parseInt(newVaultData.startYear) || currentYear, currentYear);
              let startDate = new Date(safeYStart, mIndexStart, Math.min(Math.max(1, parseInt(newVaultData.startDay)||1), 31));
              if(startDate <= today) { startDate = new Date(today); startDate.setDate(today.getDate() + 1); }

              const mIndexEnd = MONTHS.findIndex(m => m.name === newVaultData.month);
              const safeYEnd = Math.max(parseInt(newVaultData.year) || currentYear, currentYear);
              let endDate = new Date(safeYEnd, mIndexEnd, Math.min(Math.max(1, parseInt(newVaultData.day)||1), 31));
              if(endDate <= startDate) { endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 1); }

              const formatDateStr = (date) => `${date.getDate()} ${MONTHS[date.getMonth()].name} ${date.getFullYear()}`;

              // Calcul APR
              const diffTime = Math.abs(endDate - startDate);
              const durationInDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 365;
              const juniorVal = parseFloat(newVaultData.junior || 0);

              const newVault = {
                  id: `0x${Math.floor(Math.random() * 10000)}...new`,
                  name: newVaultData.name || "New Cat Bond",
                  insurerAddress: userFullAddress,
                  insurer: newVaultData.companyName || `Insurer (${userAddress})`,
                  description: finalDescription,
                  totalCapacity: capVal + premiumVal,
                  claimAmount: claimVal,
                  currentAssets: 0,
                  juniorCapital: juniorVal,
                  premium: premiumVal,
                  startDate: formatDateStr(startDate),
                  maturityDate: formatDateStr(endDate),
                  apr: ((capVal - juniorVal) > 0 ? ((premiumVal * 100 * 365) / ((capVal - juniorVal) * durationInDays)).toFixed(2) : "0.00"),
                  riskProb: (Math.random() * 19 + 1).toFixed(1),
                  status: "PENDING",
                  chain: newVaultData.chain,
                  asset: newVaultData.asset,
                  balancesJunior: {},
                  balancesSenior: {},
                  totalJuniorDeposits: 0,
                  totalSeniorDeposits: 0,
                  history: generateMockHistory('WIND')
              };

              setVaults([...vaults, newVault]);
              showNotification(`Vault successfully created!`, 'success');

              // Reset formulaire (avec dates valides par défaut)
              setNewVaultData(prev => ({
                  ...prev,
                  name: '',
                  description: '',
                  cap: '',
                  startDay: startDate.getDate(),
                  startMonth: MONTHS[startDate.getMonth()].name,
                  startYear: startDate.getFullYear()
              }));
          };

          // --- INITIALISATION (Calcul APR avec Dates) ---
          const handleInitializeVault = (vaultId) => {
             const premiumValue = parseFloat(newVaultData.premium || 0);
             const updatedVaults = vaults.map(v => {
               if (v.id === vaultId) {
                 const start = parseAppDate(v.startDate);
                 const end = parseAppDate(v.maturityDate);

                 // Durée du contrat en jours
                 const diffTime = Math.abs(end - start);
                 const durationInDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 365;

                 return {
                   ...v,
                   status: "OPEN",
                   premium: premiumValue,
                   currentAssets: v.juniorCapital + premiumValue,
                   // APR FIXE : (Premium / Capital) * (365 / Duration)
                   apr: ((premiumValue * 100 * 365) / ((v.totalCapacity - premiumValue - v.juniorCapital) * durationInDays)).toFixed(2),
                 };
               }
               return v;
             });
             setVaults(updatedVaults);
             showNotification(isLiveMode ? "Vault Initialized (Live Mock)" : "Vault Initialized (Simulation)", 'success');
          };

          // GESTION DU POURCENTAGE DE DÉPÔT
          const handleSetPercentage = (percent) => {
              if (assetBalance <= 0) return;
              const amount = (assetBalance * percent) / 100;
              const remaining = selectedVault.totalCapacity - selectedVault.currentAssets;
              const finalAmount = amount > remaining ? remaining : amount;
              setDepositAmount(finalAmount.toFixed(4));
              if (amount > remaining) showNotification("Amount adjusted to the maximum remaining capacity.", 'info');
          };

          const handleDeposit = async () => {
            if (!walletConnected) { showNotification("Connect your wallet.", 'error'); return; }

            // --- CHECK KYC INVESTISSEUR ---
            if (!isInvestorWhitelisted) {
                    // Vérifier si une demande est déjà en cours (Pending)
                    const requests = JSON.parse(localStorage.getItem('moeba_investor_requests') || '[]');
                    const myRequest = requests.find(r => r.address.toLowerCase() === userFullAddress.toLowerCase());

                    if (myRequest && myRequest.status === 1) {
                        showNotification("KYC under review. Please wait for admin validation.", 'info');
                    } else if (myRequest && myRequest.status === 3) {
                        showNotification("KYC Rejected by admin.", 'error');
                    } else {
                        // Si aucune demande, on ouvre le formulaire
                        setShowInvestorKYC(true);
                    }
                    return;
                }

            if (!selectedVault || !depositAmount) return;
            const amount = parseFloat(depositAmount);
            if (amount <= 0) { showNotification("Invalid amount.", 'error'); return; }

            const remainingCapacity = selectedVault.totalCapacity - selectedVault.currentAssets;
            if (amount > remainingCapacity) {
                showNotification(`Error: Capacity exceeded (${formatCurrency(remainingCapacity)}).`, 'error');
                return;
            }

            // Gestion Multi-Wallet via 'balances' + TRANCHES
            const currentBalances = selectedVault.balances || {};
            const newUserBalance = (currentBalances[userFullAddress] || 0) + amount;
            const newBalances = { ...currentBalances, [userFullAddress]: newUserBalance };

            // TRANCHE LOGIC
            let newTotalJunior = selectedVault.totalJuniorDeposits || 0;
            let newTotalSenior = selectedVault.totalSeniorDeposits || 0;
            const newBalancesJunior = { ...(selectedVault.balancesJunior || {}) };
            const newBalancesSenior = { ...(selectedVault.balancesSenior || {}) };

            if (trancheType === 'junior') {
                newTotalJunior += amount;
                newBalancesJunior[userFullAddress] = (newBalancesJunior[userFullAddress] || 0) + amount;
            } else {
                newTotalSenior += amount;
                newBalancesSenior[userFullAddress] = (newBalancesSenior[userFullAddress] || 0) + amount;
            }

            const updatedVault = {
                 ...selectedVault,
                 currentAssets: selectedVault.currentAssets + amount,
                 userBalance: newUserBalance,
                 balances: newBalances,
                 balancesJunior: newBalancesJunior,
                 balancesSenior: newBalancesSenior,
                 totalJuniorDeposits: newTotalJunior,
                 totalSeniorDeposits: newTotalSenior
            };
            setSelectedVault(updatedVault);
            setVaults(vaults.map(v => v.id === selectedVault.id ? updatedVault : v));
            showNotification(`Deposit of ${amount} ${selectedVault.asset} (${trancheType === 'junior' ? 'Junior' : 'Senior'}) confirmed.`, 'success');
            setDepositAmount('');
          };

          // --- FONCTION DE RETRAIT (de app.html) ---
          const handleWithdraw = async () => {
             if (!walletConnected) return;
             const amount = parseFloat(withdrawAmount);
             // Verify specific tranche balance
             const currentJunior = selectedVault.balancesJunior ? (selectedVault.balancesJunior[userFullAddress] || 0) : 0;
             const currentSenior = selectedVault.balancesSenior ? (selectedVault.balancesSenior[userFullAddress] || 0) : 0;
             const available = trancheType === 'junior' ? currentJunior : currentSenior;

             if (amount <= 0 || amount > available) { showNotification(`Invalid amount or insufficient ${trancheType} balance.`, 'error'); return; }

             // Gestion Multi-Wallet via 'balances'
             const currentBalances = selectedVault.balances || {};
             const newUserBalance = (currentBalances[userFullAddress] || 0) - amount;
             const newBalances = { ...currentBalances, [userFullAddress]: newUserBalance };

             // UPDATE TRANCHE
             const newBalancesJunior = { ...(selectedVault.balancesJunior || {}) };
             const newBalancesSenior = { ...(selectedVault.balancesSenior || {}) };
             let newTotalJunior = selectedVault.totalJuniorDeposits || 0;
             let newTotalSenior = selectedVault.totalSeniorDeposits || 0;

             if (trancheType === 'junior') {
                 newTotalJunior -= amount;
                 newBalancesJunior[userFullAddress] = currentJunior - amount;
             } else {
                 newTotalSenior -= amount;
                 newBalancesSenior[userFullAddress] = currentSenior - amount;
             }

             const updatedVault = {
                 ...selectedVault,
                 currentAssets: selectedVault.currentAssets - amount,
                 userBalance: newUserBalance,
                 balances: newBalances,
                 balancesJunior: newBalancesJunior,
                 balancesSenior: newBalancesSenior,
                 totalJuniorDeposits: newTotalJunior,
                 totalSeniorDeposits: newTotalSenior
            };
            setSelectedVault(updatedVault);
            setVaults(vaults.map(v => v.id === selectedVault.id ? updatedVault : v));
            showNotification(`Withdrawal of ${amount} (${trancheType}) completed.`, 'success');
            setWithdrawAmount('');
          };

          const handleTriggerOracle = (vaultId) => {
            setVaults(vaults.map(v => v.id === vaultId ? { ...v, status: "TRIGGERED" } : v));
            showNotification(<AlertTriangle className="h-8 w-8" /> && "ORACLE ALERT : Catastrophe confirmed. Soft Default activated.", 'error');
          };

          // CALCUL CASCADE DE PERTE
          const calculateClaimStats = (vault) => {
              const claimNeeded = vault.claimAmount || vault.totalCapacity; // Total Loss
              const insurerCover = vault.juniorCapital; // First Loss (Assurance)

              // Insurer pays first
              const insurerLoss = Math.min(claimNeeded, insurerCover);
              let remainingLoss = Math.max(0, claimNeeded - insurerLoss);

              // Junior Investors pay second
              const juniorPool = vault.totalJuniorDeposits || 0;
              const juniorLoss = Math.min(remainingLoss, juniorPool);
              remainingLoss = Math.max(0, remainingLoss - juniorLoss);
              const juniorRecoveryRatio = juniorPool > 0 ? (juniorPool - juniorLoss) / juniorPool : 0;

              // Senior Investors pay last
              const seniorPool = vault.totalSeniorDeposits || 0;
              const seniorLoss = Math.min(remainingLoss, seniorPool);
              // remainingLoss after senior is uncovered loss
              const seniorRecoveryRatio = seniorPool > 0 ? (seniorPool - seniorLoss) / seniorPool : 0;

              return { juniorRecoveryRatio, seniorRecoveryRatio };
          };

          // Fonction utilitaire pour centraliser le calcul des APRs
          const getTrancheAprs = (vault) => {
              const baseApr = parseFloat(vault.apr || 0);

              const seniorApr = baseApr * 0.7;

              const senCap = vault.totalSeniorDeposits || 0;
              const junCap = vault.totalJuniorDeposits > 0 ? vault.totalJuniorDeposits : (vault.juniorCapital || 1);

              const totalInvested = senCap + junCap;
              const totalYield = totalInvested * (baseApr / 100);
              const seniorCost = senCap * (seniorApr / 100);

              let juniorApr = ((totalYield - seniorCost) / junCap) * 100;

              // Fallback si vide
              if (senCap === 0 && vault.totalJuniorDeposits === 0) {
                  juniorApr = baseApr;
              }

              return { seniorApr, juniorApr: Math.max(0, juniorApr) };
          };

          const calculatePayoutDetails = (vault) => {
              // Appel au Helper
              const { seniorApr, juniorApr } = getTrancheAprs(vault);


              // Get User Balances in Tranches
              const userJunior = vault.balancesJunior ? (vault.balancesJunior[userFullAddress] || 0) : 0;
              const userSenior = vault.balancesSenior ? (vault.balancesSenior[userFullAddress] || 0) : 0;

              // Calculate Time Duration for Yield
              const start = parseAppDate(vault.startDate) || new Date();
              const end = parseAppDate(vault.maturityDate) || new Date();
              const diffTime = Math.max(0, Math.abs(end - start));
              const durationYear = diffTime / (1000 * 60 * 60 * 24 * 365);

              // YIELD Payout
              const juniorYield = userJunior * (juniorApr / 100) * durationYear;
              const seniorYield = userSenior * (seniorApr / 100) * durationYear;
              const totalYield = juniorYield + seniorYield;

              let principalRecoveredJunior = userJunior;
              let principalRecoveredSenior = userSenior;
              let totalLoss = 0;

              if (vault.status === 'TRIGGERED') {
                  const { juniorRecoveryRatio, seniorRecoveryRatio } = calculateClaimStats(vault);
                  principalRecoveredJunior = userJunior * juniorRecoveryRatio;
                  principalRecoveredSenior = userSenior * seniorRecoveryRatio;
                  totalLoss = (userJunior - principalRecoveredJunior) + (userSenior - principalRecoveredSenior);
              }

              const principalRecovered = principalRecoveredJunior + principalRecoveredSenior;
              const totalPayout = principalRecovered + totalYield;

              return { principalRecovered, yieldPayout: totalYield, loss: totalLoss, totalPayout };
          };

          const handleClaim = (vault) => {
              const details = calculatePayoutDetails(vault);
              showNotification(`Claim of ${formatCurrency(details.totalPayout)} paid.`, 'success');

              // Mise à jour balance utilisateur courant
              const currentBalances = vault.balances || {};
              const newBalances = { ...currentBalances, [userFullAddress]: 0 };
              // Clear Tranche Balances
              const newBalancesJunior = { ...(vault.balancesJunior || {}), [userFullAddress]: 0 };
              const newBalancesSenior = { ...(vault.balancesSenior || {}), [userFullAddress]: 0 };

              const updatedVault = {
                  ...vault,
                  userBalance: 0,
                  balances: newBalances,
                  balancesJunior: newBalancesJunior,
                  balancesSenior: newBalancesSenior
              };
              setSelectedVault(updatedVault);
              setVaults(vaults.map(v => v.id === vault.id ? updatedVault : v));
          };

          const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);

          // VERIFICATION STATUS "STARTED" (de app.html)
          const isVaultStarted = (vault) => {
              if (!vault || !vault.startDate) return false;
              const start = parseAppDate(vault.startDate);
              return start && new Date() >= start;
          };

          // RENDER
          return (
            <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans animate-fade-in transition-colors duration-300 relative">

              <NotificationToast message={notification.message} type={notification.type} onClose={() => setNotification({message:'', type:'info'})} />

              {/* --- MODAL KYB ASSUREUR --- */}
              <InsurerRegistrationModal
                  isOpen={showInsurerRegistration}
                  onClose={() => setShowInsurerRegistration(false)}
                  onSubmit={handleInsurerRegistration}
                  isSubmitting={isRegistering}
              />

              {/* --- MODAL KYC INVESTISSEUR --- */}
              <InvestorKYCModal
                  isOpen={showInvestorKYC}
                  onClose={() => setShowInvestorKYC(false)}
                  onSubmit={handleInvestorKYC}
                  isSubmitting={isInvestorRegistering}
              />

              {/* --- MODAL SELECTEUR DE WALLET --- */}
              {showWalletSelector && (
                  <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setShowWalletSelector(false)}>
                      <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200 dark:border-slate-700 overflow-hidden animate-zoom-in" onClick={e => e.stopPropagation()}>
                          <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                              <h3 className="font-bold text-lg text-slate-900 dark:text-white">Connect Wallet</h3>
                              <button onClick={() => setShowWalletSelector(false)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                                  <X className="h-5 w-5 text-slate-500" />
                              </button>
                          </div>

                          <div className="p-4 space-y-3">
                              {/* RABBY */}
                              <button onClick={() => handleWalletSelect('rabby')} className="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700 group">
                                  <RabbyIcon />
                                  <span className="font-bold text-slate-700 dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">Rabby Wallet</span>
                              </button>

                              {/* ZERION */}
                              <button onClick={() => handleWalletSelect('zerion')} className="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700 group">
                                  <ZerionIcon />
                                  <span className="font-bold text-slate-700 dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">Zerion Wallet</span>
                              </button>

                              {/* AUTRES WALLETS (DROPDOWN) */}
                              <div className="border-t border-slate-100 dark:border-slate-800 pt-2 mt-2">
                                  <button onClick={() => setShowOtherWallets(!showOtherWallets)} className="w-full flex items-center justify-between p-3 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                                      <span>Other Wallets</span>
                                      <ChevronDown className={`h-4 w-4 transition-transform duration-300 ${showOtherWallets ? 'rotate-180' : ''}`} />
                                  </button>

                                  {showOtherWallets && (
                                      <div className="space-y-2 mt-2 animate-slide-up">
                                          <button onClick={() => handleWalletSelect('simulation')} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors group">
                                              <SimulationIcon />
                                              <span className="font-medium text-slate-700 dark:text-slate-300">Simulation Wallet</span>
                                          </button>
                                          <button onClick={() => handleWalletSelect('metamask')} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors group">
                                              <MetaMaskIcon />
                                              <span className="font-medium text-slate-700 dark:text-slate-300">MetaMask</span>
                                          </button>
                                          <button onClick={() => handleWalletSelect('walletconnect')} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors group">
                                              <WalletConnectIcon />
                                              <span className="font-medium text-slate-700 dark:text-slate-300">WalletConnect</span>
                                          </button>
                                      </div>
                                  )}
                              </div>
                          </div>
                      </div>
                  </div>
              )}

              {/* NAVBAR */}
              <nav className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-50 shadow-sm transition-colors duration-300">
                <div className="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between h-16 items-center">

                    <div className="flex items-center gap-4">
                      <a href="#" className="flex items-center">
                        <img src="../img/MoebaLogo.png" alt="MOEBA" className="h-12 w-auto" />
                      </a>

                      <div className="hidden md:flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-full ml-4">
                         <button onClick={() => setIsLiveMode(false)} className={`px-3 py-1 text-xs font-bold rounded-full transition-all flex items-center gap-1 ${!isLiveMode ? 'bg-white dark:bg-slate-600 shadow text-slate-900 dark:text-white' : 'text-slate-500 hover:text-slate-700'}`}><RefreshCw className="h-3 w-3" /> Simulation</button>
                         <button onClick={() => setIsLiveMode(true)} className={`px-3 py-1 text-xs font-bold rounded-full transition-all flex items-center gap-1 ${isLiveMode ? 'bg-red-500 shadow text-white' : 'text-slate-500 hover:text-slate-700'}`}><Zap className="h-3 w-3" /> Live</button>
                      </div>
                    </div>

                    <div className="flex items-center gap-4">
                      <div className="hidden md:flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 transition-colors">
                        <button onClick={() => { setActiveRole('investor'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'investor' ? 'bg-white dark:bg-slate-700 shadow-sm text-blue-700 dark:text-blue-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Investor</button>
                        <button onClick={() => { setActiveRole('insurer'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'insurer' ? 'bg-white dark:bg-slate-700 shadow-sm text-indigo-700 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Insurer</button>
                        <button onClick={() => { setActiveRole('dashboard'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'dashboard' ? 'bg-white dark:bg-slate-700 shadow-sm text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Dashboard</button>
                        <button onClick={() => { setActiveRole('oracle'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'oracle' ? 'bg-white dark:bg-slate-700 shadow-sm text-red-600 dark:text-red-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Oracle</button>
                      </div>

                      <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                      <button onClick={toggleTheme} className="p-2 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                        {isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
                      </button>

                      <div className="relative">
                          <button
                            onClick={() => walletConnected ? setShowWalletMenu(!showWalletMenu) : openWalletSelector()}
                            className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-colors border ${walletConnected ? 'bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800' : 'bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200 border-transparent'}`}
                          >
                            <Wallet className="h-4 w-4" />
                            {walletConnected ? (
                                <span className="text-xs font-bold">{userAddress}</span>
                            ) : (
                                <span>Connect Wallet</span>
                            )}
                          </button>

                          {walletConnected && showWalletMenu && (
                              <div className="absolute right-0 top-full mt-2 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 p-2 z-50 flex flex-col gap-1">
                                <a
                                    href={`https://etherscan.io/address/${userFullAddress}`}
                                    target="_blank"
                                    rel="noreferrer"
                                    className="flex items-center gap-2 px-3 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors"
                                >
                                    <Globe className="h-4 w-4" /> <span>Etherscan</span>
                                </a>
                                <button
                                    onClick={() => { disconnectWallet(); setShowWalletMenu(false); }}
                                    className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors w-full text-left"
                                >
                                    <LogOut className="h-4 w-4" /> <span>Disconnect</span>
                                </button>
                              </div>
                          )}
                      </div>
                    </div>
                  </div>
                </div>
              </nav>

              <main className="max-w-[89%] mx-auto px-4 sm:px-6 lg:px-8 py-8">

                {/* --- VUE INVESTISSEUR --- */}
                {activeRole === 'investor' && (
                  <div className="space-y-6 animate-in fade-in duration-500">

                    {!selectedVault && (
                        <div className="space-y-6">

                            {/* EN-TÊTE + FILTRES MULTI-CHAINS */}
                            <div className="flex flex-col gap-6">
                              <div>
                                <h2 className="text-4xl font-bold text-slate-900 dark:text-white">Vaults Opportunities</h2>
                                <p className="text-slate-500 dark:text-slate-400 mt-1">Invest in Swiss-compliant parametric risks, secured by a fully funded blockchain infrastructure.</p>
                              </div>

                              {/* BARRE DE FILTRES BLOCKCHAINS */}
                              <div className="w-full flex flex-wrap items-center gap-2 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-transparent via-pink-50/30 to-pink-200/50 dark:from-transparent dark:via-pink-900/10 dark:to-pink-800/30 p-2 rounded-xl">
                                <span className="text-xs font-bold text-slate-400 px-2 uppercase tracking-wide flex items-center gap-1"><Globe className="h-4 w-4" /> Network</span>
                                {AVAILABLE_CHAINS.filter(chain => vaults.some(v => v.chain === chain)).map(chain => (
                                    <button
                                        key={chain}
                                        onClick={() => toggleChainFilter(chain)}
                                        title={chain}
                                        className={`p-2 rounded-lg transition-all border ${
                                            selectedChains.includes(chain)
                                            ? 'bg-blue-100 dark:bg-blue-900/50 border-blue-500 shadow-sm'
                                            : 'bg-white dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 hover:border-blue-300'
                                        }`}
                                    >
                                        <img src={CHAIN_LOGOS[chain]} alt={chain} className="w-6 h-6 object-contain" />
                                    </button>
                                ))}

                                <div className="ml-auto flex items-center gap-2">
                                  {/* BOUTONS TOGGLE VIEW MODE (LISTE / GRILLE) */}
                                  <div className="flex bg-white dark:bg-slate-700 rounded-lg p-1 border border-slate-200 dark:border-slate-600">
                                      <button
                                        onClick={() => setViewMode('list')}
                                        className={`p-1.5 rounded-md transition-all ${viewMode === 'list' ? 'bg-slate-100 dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}
                                        title="Vue Liste"
                                      >
                                          <List className="h-4 w-4" />
                                      </button>
                                      <button
                                        onClick={() => setViewMode('grid')}
                                        className={`p-1.5 rounded-md transition-all ${viewMode === 'grid' ? 'bg-slate-100 dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}
                                        title="Vue Grille"
                                      >
                                          <LayoutGrid className="h-4 w-4" />
                                      </button>
                                  </div>

                                  {(selectedChains.length > 0 || searchQuery || aprSort !== 'neutral' || maturitySort !== 'neutral') && (
                                      <button onClick={() => { setSelectedChains([]); setSearchQuery(''); setAprSort('neutral'); setMaturitySort('neutral'); }} className="px-2 py-1 text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                          Reset Filtres
                                      </button>
                                  )}
                                </div>
                              </div>

                              {/* BARRE DE FILTRES APR CROISSANT/DECROISSANT & MATURITE & SEARCH */}
                              <div className="flex flex-wrap items-center gap-3">
                                  {/* BOUTON TRI APR */}
                                  <button
                                    onClick={toggleAprSort}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all border select-none ${
                                        aprSort !== 'neutral'
                                        ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300 shadow-sm'
                                        : 'bg-white dark:bg-slate-800/30 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                                    }`}
                                  >
                                      <span className="font-bold text-sm">APR</span>
                                      {aprSort === 'neutral' && <span className="text-slate-300">⇅</span>}
                                      {aprSort === 'desc' && <span>↓</span>}
                                      {aprSort === 'asc' && <span>↑</span>}
                                  </button>

                                  {/* BOUTON TRI MATURITE */}
                                  <button
                                    onClick={toggleMaturitySort}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all border select-none ${
                                        maturitySort !== 'neutral'
                                        ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-300 shadow-sm'
                                        : 'bg-white dark:bg-slate-800/30 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                                    }`}
                                  >
                                      <span className="font-bold text-sm">Maturity</span>
                                      {maturitySort === 'neutral' && <span className="text-slate-300">⇅</span>}
                                      {maturitySort === 'asc' && <span>→</span>}
                                      {maturitySort === 'desc' && <span>←</span>}
                                  </button>

                                  {/* BUTTON RISK SORT */}
                                  <button
                                    onClick={toggleRiskSort}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all border select-none ${
                                        riskSort !== 'neutral'
                                        ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-300 shadow-sm'
                                        : 'bg-white dark:bg-slate-800/30 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                                    }`}
                                  >
                                      <span className="font-bold text-sm">Risk</span>
                                      {riskSort === 'neutral' && <span className="text-slate-300">⇅</span>}
                                      {riskSort === 'asc' && <span>↓</span>}
                                      {riskSort === 'desc' && <span>↑</span>}
                                  </button>

                                  {/* CHAMP RECHERCHE */}
                                  <div className="relative ml-auto flex-1 min-w-[200px] max-w-sm">
                                      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                          <Search className="h-4 w-4 text-slate-400" />
                                      </div>
                                      <input
                                          type="text"
                                          value={searchQuery}
                                          onChange={(e) => setSearchQuery(e.target.value)}
                                          className="block w-full pl-10 pr-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm"
                                          placeholder="Search (e.g., USDC, Florida...)"
                                      />
                                  </div>
                              </div>

                            </div>

                            {/* CONTENEUR GRILLE / LISTE */}
                            <div className={`grid gap-6 ${viewMode === 'grid' ? 'grid-cols-1 lg:grid-cols-2' : 'grid-cols-1'}`}>
                              {filteredVaults.length === 0 ? (
                                  <div className="col-span-full py-12 text-center text-slate-400 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700">
                                      No vault found with these criteria.
                                  </div>
                              ) : (
                                  filteredVaults.map((vault) => {
                                    // Vérification si le vault est complet
                                    const isFull = vault.currentAssets >= vault.totalCapacity;
                                    // CHECK STATUT DE DEMARRAGE
                                    const started = isVaultStarted(vault);

                                    if (viewMode === 'list') {
                                        // VUE LISTE COMPACTE
                                        return (
                                            <div
                                                key={vault.id}
                                                onClick={() => setSelectedVault(vault)}
                                                className={`group relative rounded-xl border transition-all cursor-pointer hover:shadow-md
                                                    ${vault.status === 'TRIGGERED' ? 'bg-red-50/50 dark:bg-red-900/10 border-red-200 dark:border-red-900' :
                                                    vault.status === 'MATURED' ? 'bg-green-50/50 dark:bg-green-900/10 border-green-200 dark:border-green-900' :
                                                    isFull && vault.status === 'OPEN' ? 'bg-slate-100/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-600 opacity-90' :
                                                    'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-500'}`}
                                            >
                                                <div className="p-4 relative flex flex-col md:flex-row md:items-center gap-6">

                                                    {/* MAIN INFO & BADGES */}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex flex-wrap items-center gap-2 mb-2">
                                                            <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 uppercase tracking-wider">
                                                                {vault.chain}
                                                            </span>
                                                            <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 border border-blue-100 dark:border-blue-800 uppercase tracking-wider">
                                                                {vault.asset}
                                                            </span>
                                                            {vault.status === 'OPEN' && !started && <span className="px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1"><CheckCircle2 className="h-3 w-3" /> OPEN</span>}
                                                            {vault.status === 'OPEN' && started && <span className="px-2 py-0.5 rounded-full text-[10px] font-bold bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 flex items-center gap-1"><Lock className="h-3 w-3" /> LOCKED</span>}
                                                            {vault.status === 'MATURED' && <span className="px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1"><CheckCircle2 className="h-3 w-3" /> COMPLETED</span>}
                                                            {vault.status === 'PENDING' && <span className="px-2 py-0.5 rounded-full text-[10px] font-bold bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 flex items-center gap-1"><Activity className="h-3 w-3" /> PENDING</span>}
                                                            {vault.status === 'TRIGGERED' && <span className="px-2 py-0.5 rounded-full text-[10px] font-bold bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400 flex items-center gap-1"><AlertTriangle className="h-3 w-3" /> DISASTER</span>}
                                                        </div>
                                                        <h3 className="text-xl font-bold text-slate-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{vault.name}</h3>
                                                        <p className="text-sm text-slate-500 dark:text-slate-400 truncate flex items-center gap-1 mt-1">
                                                            <Building2 className="h-3 w-3" /> {vault.insurer}
                                                        </p>
                                                    </div>

                                                    <div className="w-full max-w-[500px] grid grid-cols-[auto_0.5fr_auto_0.5fr_auto_1.6fr] items-center gap-4">

                                                        {/* --- SEPARATEUR --- */}
                                                        <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-auto"></div>

                                                        {/* --- BLOC 1 : RISQUE --- */}
                                                        <div className="flex flex-col items-start">
                                                            <span className="text-sm text-slate-400 dark:text-slate-500">Risk</span>
                                                            <span className={`text-ml font-bold ${vault.riskProb > 10 ? 'text-red-600 dark:text-red-400' : 'text-orange-500 dark:text-orange-400'}`}>
                                                                {vault.riskProb}%
                                                            </span>
                                                        </div>

                                                        {/* --- SEPARATEUR --- */}
                                                        <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-auto"></div>

                                                        {/* --- BLOC 2 : APR --- */}
                                                        <div className="flex flex-col items-start">
                                                            <span className="text-sm text-slate-400 dark:text-slate-500">APR</span>
                                                            <span className={`text-ml font-bold leading-none ${
                                                                vault.status === 'OPEN' || vault.status === 'MATURED'
                                                                ? 'text-green-600 dark:text-green-400'
                                                                : 'text-slate-400 dark:text-slate-500'
                                                            }`}>
                                                                {vault.apr}%
                                                            </span>
                                                        </div>

                                                        {/* --- SEPARATEUR --- */}
                                                        <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-auto"></div>

                                                        {/* --- BLOC 3 : LEVÉE --- */}
                                                        <div className="flex flex-col items-start">
                                                            <span className="text-sm text-slate-400 dark:text-slate-500">Funds raised</span>
                                                            <span className="text-ml font-bold text-slate-700 dark:text-slate-300">
                                                                {formatCurrency(vault.currentAssets)}
                                                                <span className="text-slate-400 dark:text-slate-500 text-sm font-normal ml-1">
                                                                    / {formatCurrency(vault.totalCapacity)}
                                                                </span>
                                                            </span>
                                                        </div>

                                                    </div>


                                                    {/* DÉBUT ET MATURITÉ */}
                                                    <div className="flex flex-wrap items-center gap-14 justify-end pr-[74px] relative">

                                                        {/* BOXES */}
                                                        <div className="flex flex-col gap-4">
                                                            <div className="w-[350px] h-[70px] relative flex items-center gap-4 bg-slate-50 dark:bg-slate-900/50 px-4 py-4 rounded-xl border border-slate-100 dark:border-slate-700 shrink-0">
                                                                <div>
                                                                    <p className="text-sm text-slate-400 dark:text-slate-500">Beginning</p>
                                                                    <p className="text-sm font-bold text-slate-700 dark:text-slate-300">{vault.startDate || 'N/A'}</p>
                                                                </div>

                                                                {/* Barre */}
                                                                <div
                                                                className="absolute top-1/2 -translate-y-1/2 flex items-center gap-10 pointer-events-none"
                                                                style={{ left: '50%' }}
                                                                >
                                                                    <div className="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
                                                                </div>

                                                                <div className="absolute top-1/2 -translate-y-1/2 right-4 flex items-center gap-10 pointer-events-none">
                                                                    <div className="text-right">
                                                                        <p className="text-sm text-slate-400 dark:text-slate-500">Maturity</p>
                                                                        <p className="text-sm font-bold text-slate-700 dark:text-slate-300">{vault.maturityDate}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* ARROW */}
                                                        <div className="absolute right-0 top-1/2 -translate-y-1/2 text-slate-300 dark:text-slate-600 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors hidden md:block">
                                                            <ArrowRight className="h-5 w-5" />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="pl-4 pr-[90px]">
                                                    <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2 mb-4 overflow-hidden">
                                                    <div
                                                        className={`h-full rounded-full transition-all duration-1000 ${vault.status === 'TRIGGERED' ? 'bg-red-500' : vault.status === 'MATURED' ? 'bg-green-500' : isFull ? 'bg-slate-500' : 'bg-blue-600'}`}
                                                        style={{ width: `${(vault.currentAssets / vault.totalCapacity) * 100}%` }}
                                                    ></div>
                                                    </div>
                                                </div>

                                            </div>
                                        );
                                    }

                                    // VUE GRILLE
                                    return (
                                    <div
                                        key={vault.id}
                                        onClick={() => setSelectedVault(vault)}
                                        className={`group relative bg-white dark:bg-slate-800 rounded-2xl border transition-all cursor-pointer
                                            ${vault.status === 'TRIGGERED' ? 'border-red-200 dark:border-red-900 bg-red-50/50 dark:bg-red-900/20' :
                                            vault.status === 'MATURED' ? 'border-green-200 dark:border-green-900 bg-green-50/50 dark:bg-green-900/20' :
                                            isFull && vault.status === 'OPEN' ? 'border-slate-300 dark:border-slate-600 bg-slate-100/50 dark:bg-slate-800/50 opacity-90' :
                                            'border-slate-200 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-500 hover:shadow-lg'}`}
                                    >
                                      <div className="absolute top-6 right-6 flex flex-col items-end gap-2">
                                        {/* BADGES */}
                                        {vault.status === 'OPEN' && !started && !isFull && <span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1"><CheckCircle2 className="h-3 w-3" /> OPEN</span>}
                                        {vault.status === 'OPEN' && started && <span className="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 flex items-center gap-1"><Lock className="h-3 w-3" /> LOCKED</span>}
                                        {vault.status === 'OPEN' && isFull && !started && <span className="px-3 py-1 rounded-full text-xs font-bold bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 flex items-center gap-1"><Lock className="h-3 w-3" /> SOLD OUT</span>}
                                        {vault.status === 'MATURED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1"><CheckCircle2 className="h-3 w-3" /> OVER</span>}
                                        {vault.status === 'PENDING' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 flex items-center gap-1"><Activity className="h-3 w-3" /> PENDING</span>}
                                        {vault.status === 'TRIGGERED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400 flex items-center gap-1"><AlertTriangle className="h-3 w-3" /> DISASTER</span>}
                                      </div>

                                      <div className="p-6">
                                        <div className="mb-6">
                                          {/* BADGE NETWORK & ASSET DANS LA CARTE */}
                                          <div className="flex gap-2 mb-3">
                                              <span className="px-2 py-0.5 rounded-md bg-slate-100 dark:bg-slate-700 text-[10px] font-bold text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 uppercase tracking-wider">
                                                  {vault.chain}
                                              </span>
                                              <span className="px-2 py-0.5 rounded-md bg-blue-50 dark:bg-blue-900/30 text-[10px] font-bold text-blue-600 dark:text-blue-300 border border-blue-100 dark:border-blue-800 uppercase tracking-wider">
                                                  {vault.asset}
                                              </span>
                                          </div>

                                          <h3 className="text-xl font-bold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{vault.name}</h3>
                                          <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-2">
                                            <Building2 className="h-3 w-3" /> Insurer: {vault.insurer}
                                          </p>
                                        </div>

                                        <div className="flex justify-between items-end mb-6">
                                          <div>
                                            <p className="text-sm text-slate-500 dark:text-slate-400 mb-1">Yield (APR)</p>
                                            <p className={`text-4xl font-bold ${vault.status === 'OPEN' ? 'text-green-600 dark:text-green-400' : 'text-slate-400 dark:text-slate-500'}`}>
                                              {vault.apr}%
                                            </p>
                                          </div>
                                          <div className="text-right">
                                            <p className="text-sm text-slate-500 dark:text-slate-400 mb-1">Funds raised</p>
                                            <p className="text-lg font-semibold text-slate-900 dark:text-white">
                                              {formatCurrency(vault.currentAssets)} <span className="text-slate-400 dark:text-slate-500 text-sm font-normal">/ {formatCurrency(vault.totalCapacity)}</span>
                                            </p>
                                          </div>
                                        </div>

                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-sm font-medium text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                                <AlertTriangle className="h-3 w-3 text-orange-500" /> Probability of loss
                                            </span>
                                            <span className={`text-sm font-bold ${vault.riskProb > 10 ? 'text-red-600 dark:text-red-400' : 'text-orange-500 dark:text-orange-400'}`}>
                                                {vault.riskProb}%
                                            </span>
                                        </div>

                                        <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-3 mb-6 overflow-hidden">
                                          <div
                                            className={`h-full rounded-full transition-all duration-1000 ${vault.status === 'TRIGGERED' ? 'bg-red-500' : vault.status === 'MATURED' ? 'bg-green-500' : isFull ? 'bg-slate-500' : 'bg-blue-600'}`}
                                            style={{ width: `${(vault.currentAssets / vault.totalCapacity) * 100}%` }}
                                          ></div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                                          <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                            <p className="text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider mb-1">Inception Date (Lock)</p>
                                            <p className="font-semibold text-slate-900 dark:text-white">{vault.startDate || 'N/A'}</p>
                                          </div>
                                          <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                            <p className="text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider mb-1">Maturity (Unlock)</p>
                                            <p className="font-semibold text-slate-900 dark:text-white">{vault.maturityDate}</p>
                                          </div>
                                        </div>

                                        <div className="flex justify-center items-center gap-2 text-blue-600 dark:text-blue-400 text-sm font-medium">
                                            <span>View details {vault.status === 'OPEN' && !isFull ? '& Invest' : ''}</span> <ArrowRight className="h-4 w-4" />
                                        </div>
                                      </div>
                                    </div>
                                  )})
                              )}
                            </div>
                        </div>
                    )}

                    {/* VUE DÉTAILLÉE DU VAULT */}
                    {selectedVault && (() => {
                        // UTILISATION DU HELPER (Notez 'selectedVault' ici)
                        const { seniorApr, juniorApr } = getTrancheAprs(selectedVault);

                        return (
                        <div className="space-y-6">
                            <button
                                onClick={() => setSelectedVault(null)}
                                className="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors"
                            >
                                <ArrowLeft className="h-4 w-4" /> Back to the Vaults
                            </button>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 space-y-6">

                                    {/* EN-TÊTE DU VAULT */}
                                    <div className={`p-8 rounded-2xl border ${selectedVault.status === 'TRIGGERED' ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' : selectedVault.status === 'MATURED' ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="flex gap-2 mb-3">
                                                    <span className="px-2.5 py-1 rounded-md bg-slate-100 dark:bg-slate-700 text-xs font-bold text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600 uppercase tracking-wide flex items-center gap-1">
                                                        <Globe className="h-3 w-3" /> {selectedVault.chain}
                                                    </span>
                                                    <span className="px-2.5 py-1 rounded-md bg-blue-50 dark:bg-blue-900/30 text-xs font-bold text-blue-600 dark:text-blue-300 border border-blue-100 dark:border-blue-800 uppercase tracking-wide">
                                                        {selectedVault.asset}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-3 mb-2">
                                                    <h1 className={`text-3xl font-bold flex items-center gap-3 ${selectedVault.status === 'TRIGGERED' ? 'text-red-700 dark:text-red-400' : selectedVault.status === 'MATURED' ? 'text-green-700 dark:text-green-400' : 'text-slate-900 dark:text-white'}`}>
                                                        {selectedVault.status === 'TRIGGERED' && <AlertTriangle className="h-8 w-8" />}
                                                        {selectedVault.name}
                                                    </h1>
                                                    {isVaultStarted(selectedVault) && selectedVault.status !== 'MATURED' && selectedVault.status !== 'TRIGGERED' &&
                                                        <span className="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 flex items-center gap-1"><Lock className="h-3 w-3" /> ACTIVE PERIOD</span>
                                                    }
                                                    {selectedVault.status === 'MATURED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1">OVER</span>}
                                                    {selectedVault.status === 'TRIGGERED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400 flex items-center gap-1">DISASTER</span>}
                                                </div>
                                                <p className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2 mt-1">
                                                    <Building2 className="h-4 w-4" /> Insurer: <span className="font-semibold">{selectedVault.insurer}</span>
                                                    <span className="mx-2">•</span>
                                                    ID : <span className="font-mono bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-xs">{selectedVault.id}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* ALERTE CATASTROPHE */}
                                    {selectedVault.status === 'TRIGGERED' && (
                                        <div className="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-600 p-6 rounded-r-xl">
                                            <h4 className="text-xl font-bold text-red-800 dark:text-red-300 mb-2 flex items-center gap-2">
                                                <AlertTriangle className="h-6 w-6" /> Disaster Confirmed
                                            </h4>
                                            <p className="text-red-700 dark:text-red-200 mb-4 text-sm leading-relaxed">
                                                The oracle has detected an event exceeding critical thresholds. The “Soft Default” mechanism is activated.
                                            </p>
                                        </div>
                                    )}

                                    {/* INFO VAULT TERMINÉ (SUCCÈS) */}
                                    {selectedVault.status === 'MATURED' && (
                                        <div className="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-600 p-6 rounded-r-xl">
                                            <h4 className="text-xl font-bold text-green-800 dark:text-green-300 mb-2 flex items-center gap-2">
                                                <CheckCircle2 className="h-6 w-6" /> Risk Period Over
                                            </h4>
                                            <p className="text-green-700 dark:text-green-200 mb-4 text-sm leading-relaxed">
                                                The coverage period has ended without any claims being made. The principal and interest are available for withdrawal.
                                            </p>
                                        </div>
                                    )}

                                    {/* DESCRIPTION */}
                                    <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700">
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-4 flex items-center gap-2">
                                            <FileText className="h-5 w-5 text-blue-600 dark:text-blue-400"/> Trigger Conditions
                                        </h4>
                                        <div className="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-xl border border-slate-100 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 whitespace-pre-line leading-relaxed">
                                            {selectedVault.description || "No detailed description provided by the insurer."}
                                        </div>
                                    </section>

                                    {/* DONNÉES FINANCIÈRES */}
                                    <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700">
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-6 flex items-center gap-2">
                                            <Activity className="h-5 w-5 text-green-600 dark:text-green-400"/> Financial Data
                                        </h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-6">
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Total Capacity (Hard Cap)</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">{formatCurrency(selectedVault.totalCapacity)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Includes Venture Capital + Premium</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold text-indigo-600 dark:text-indigo-400">Junior Slice (First Loss)</p>
                                                <p className="text-xl font-bold text-indigo-600 dark:text-indigo-400">{formatCurrency(selectedVault.juniorCapital)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Insurance capital at risk</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold text-green-600 dark:text-green-400">Premium Reserve (Yield)</p>
                                                <p className="text-xl font-bold text-green-600 dark:text-green-400">{formatCurrency(selectedVault.premium)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Secured for investors</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Inception Date (Lock)</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">{selectedVault.startDate || 'N/A'}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Beginning of the lockdown</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Over-Collateralization</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">
                                                    {(selectedVault.totalCapacity - selectedVault.premium) > selectedVault.claimAmount ?
                                                        (((selectedVault.totalCapacity - selectedVault.premium) / selectedVault.claimAmount) * 100).toFixed(0) + '%'
                                                        : '100%'}
                                                </p>
                                                <p className="text-[10px] text-slate-400 mt-1">Ratio (Capital - Premium) / Risk</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Maturity Date</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">{selectedVault.maturityDate}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">End of the risk period</p>
                                            </div>
                                        </div>
                                    </section>

                                    {/* GRAPHIQUE RISQUE */}
                                    <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700">
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-6 flex items-center gap-2">
                                            <TrendingUp className="h-5 w-5 text-orange-600 dark:text-orange-400"/> Risk Evolution & Triggers
                                        </h4>
                                        <RiskChart data={selectedVault.history || []} triggers={selectedVault.triggers || []} />
                                    </section>
                                </div>

                                {/* SIDEBAR - GESTION POSITION */}
                                <div className="lg:col-span-1">
                                    <div className="sticky top-24 space-y-6">

                                        {/* CARTE DE POSITION UTILISATEUR */}
                                        {selectedVault.userBalance > 0 && (
                                            <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-green-200 dark:border-green-800 shadow-sm relative overflow-hidden">
                                                <div className="absolute top-0 right-0 p-3 opacity-10">
                                                    <Coins className="h-20 w-20 text-green-600" />
                                                </div>
                                                <h3 className="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">
                                                    Your Current Location
                                                </h3>
                                                <div className="mb-4">
                                                    <p className="text-3xl font-mono font-bold text-green-700 dark:text-green-400">
                                                        {formatCurrency(selectedVault.userBalance)}
                                                    </p>
                                                    <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">
                                                        Invested in {selectedVault.name}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* CARTE D'ACTION (DÉPÔT / RETRAIT) */}
                                        <div className={`bg-white dark:bg-slate-800 rounded-2xl p-6 border shadow-xl ${
                                            selectedVault.status === 'TRIGGERED' ? 'border-red-200 dark:border-red-800 shadow-red-100 dark:shadow-none' :
                                            selectedVault.status === 'MATURED' ? 'border-green-200 dark:border-green-800 shadow-green-100 dark:shadow-none' :
                                            selectedVault.status === 'PENDING' ? 'border-amber-200 dark:border-amber-800 shadow-amber-100 dark:shadow-none' : // Style pour PENDING
                                            'border-slate-200 dark:border-slate-700 shadow-slate-100 dark:shadow-none'
                                        }`}>
                                            <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                                <Wallet className="h-5 w-5" /> Position Management
                                            </h3>

                                            {selectedVault.status === 'OPEN' ? (
                                                isVaultStarted(selectedVault) ? (
                                                    <div className="text-center py-6 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-dashed border-slate-300 dark:border-slate-600">
                                                        <Lock className="h-8 w-8 text-slate-400 mx-auto mb-3" />
                                                        <p className="text-slate-600 dark:text-slate-300 font-bold">Active & Locked Vault</p>
                                                        <p className="text-xs text-slate-500 mt-2 px-4 leading-relaxed">
                                                            The subscription period ended on <strong>{selectedVault.startDate}</strong>. Withdrawals are no longer possible until maturity.
                                                        </p>
                                                        <p className="text-xs text-slate-500 mt-2 font-mono">Unlocking : {selectedVault.maturityDate}</p>
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl mb-6">
                                                            <button onClick={() => setActionTab('deposit')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${actionTab === 'deposit' ? 'bg-white dark:bg-slate-800 shadow-sm text-blue-600 dark:text-blue-400' : 'text-slate-500 dark:text-slate-400'}`}>Deposit</button>
                                                            <button onClick={() => setActionTab('withdraw')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${actionTab === 'withdraw' ? 'bg-white dark:bg-slate-800 shadow-sm text-orange-600 dark:text-orange-400' : 'text-slate-500 dark:text-slate-400'}`}>Withdrawal</button>
                                                        </div>
                                                        {/* SÉLECTEUR DE TRANCHE (Senior vs Junior) */}
                                                        <div className="mb-6 grid grid-cols-2 gap-3">
                                                            <label className="cursor-pointer">
                                                                <input type="radio" name="tranche" value="senior" checked={trancheType === 'senior'} onChange={() => setTrancheType('senior')} className="hidden peer" />
                                                                <div className="p-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 text-center transition-all h-full flex flex-col justify-center">
                                                                    <div className="font-bold text-slate-700 dark:text-slate-200">Senior</div>
                                                                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">APR { seniorApr.toFixed(2) }%</div>
                                                                    <div className="text-[10px] text-green-600 mt-1 font-medium">Payment Priority</div>
                                                                </div>
                                                            </label>
                                                            <label className="cursor-pointer">
                                                                <input type="radio" name="tranche" value="junior" checked={trancheType === 'junior'} onChange={() => setTrancheType('junior')} className="hidden peer" />
                                                                <div className="p-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 text-center transition-all h-full flex flex-col justify-center">
                                                                    <div className="font-bold text-slate-700 dark:text-slate-200">Junior</div>
                                                                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">APR { juniorApr.toFixed(2) }%</div>
                                                                    <div className="text-[10px] text-orange-500 mt-1 font-medium">Boost Yield</div>
                                                                </div>
                                                            </label>
                                                        </div>

                                                        {actionTab === 'deposit' ? (
                                                            <div className="space-y-6 animate-fade-in">
                                                                {selectedVault.currentAssets >= selectedVault.totalCapacity && (
                                                                    <div className="mb-4 p-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-center"><span className="font-bold text-slate-500 dark:text-slate-300">This vault has reached its maximum capacity.</span></div>
                                                                )}
                                                                <div className="space-y-4">
                                                                    <div className="flex justify-between items-start mb-1">
                                                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300 pt-1">
                                                                            Amount ({trancheType === 'senior' ? 'Senior' : 'Junior'})
                                                                        </label>
                                                                        <div className="text-right">
                                                                            <span className="text-xs text-slate-500 dark:text-slate-400">Balance: <span className="font-bold text-slate-700 dark:text-slate-200 cursor-pointer hover:underline" onClick={() => setDepositAmount(assetBalance.toString())}>{assetBalanceFormatted}</span> {selectedVault.asset}</span>
                                                                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">max: <span className="font-bold text-blue-600 dark:text-blue-400 cursor-pointer hover:underline" onClick={() => setDepositAmount((selectedVault.totalCapacity - selectedVault.currentAssets).toString())}>{formatCurrency(selectedVault.totalCapacity - selectedVault.currentAssets)}</span></div>
                                                                        </div>
                                                                    </div>

                                                                    <div className="relative">
                                                                        <input type="number" min="0" step="0.01" value={depositAmount} onChange={(e) => { const val = parseFloat(e.target.value); const max = selectedVault.totalCapacity - selectedVault.currentAssets; if (val > max) { setDepositAmount(max.toFixed(4)); } else { setDepositAmount(e.target.value); } }} disabled={selectedVault.currentAssets >= selectedVault.totalCapacity} className="w-full pl-4 pr-16 py-4 border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium text-lg disabled:opacity-50 disabled:cursor-not-allowed" placeholder={selectedVault.currentAssets >= selectedVault.totalCapacity ? "Sold Out" : "0.00"} />
                                                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">{selectedVault.asset}</span>
                                                                    </div>
                                                                    {walletConnected && assetBalance > 0 && selectedVault.currentAssets < selectedVault.totalCapacity && (
                                                                        <div className="flex gap-2">{[25, 50, 75, 100].map(pct => (<button key={pct} onClick={() => handleSetPercentage(pct)} className="flex-1 py-1.5 text-xs font-bold rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 hover:text-blue-600">{pct}%</button>))}</div>
                                                                    )}
                                                                </div>
                                                                <div className="space-y-3 pt-2">
                                                                    <div className="flex justify-between text-sm"><span className="text-slate-500 dark:text-slate-400">Estimated APR</span><span className={`font-bold ${trancheType === 'junior' ? 'text-indigo-600' : 'text-blue-600'}`}>{trancheType === 'junior' ? juniorApr.toFixed(2) : seniorApr.toFixed(2)}%</span></div>
                                                                    <div className="flex justify-between text-sm"><span className="text-slate-500 dark:text-slate-400">Deposit fees</span><span className="font-medium text-slate-900 dark:text-white">0.00%</span></div>
                                                                </div>
                                                                <button onClick={handleDeposit} disabled={selectedVault.currentAssets >= selectedVault.totalCapacity} className={`w-full py-4 ${trancheType === 'junior' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none transition-all flex justify-center items-center gap-2 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:shadow-none`}>{selectedVault.currentAssets >= selectedVault.totalCapacity ? "Capacity Reached" : `Confirm Deposit ${trancheType === 'junior' ? 'Junior' : 'Senior'}`} <ArrowRight className="h-4 w-4"/></button>
                                                                <p className="text-xs text-center text-slate-400 mt-2">Subscription period open until {selectedVault.startDate}.</p>
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-4 animate-fade-in">
                                                                <div className="flex justify-between items-center mb-1"><label className="text-sm font-medium text-slate-700 dark:text-slate-300">Amount to be withdrawn ({trancheType === 'senior' ? 'Senior' : 'Junior'})</label></div>
                                                                <div className="relative">
                                                                    <input type="number" value={withdrawAmount} onChange={e => setWithdrawAmount(e.target.value)} className="w-full pl-4 pr-16 py-4 border border-orange-200 dark:border-orange-800 bg-orange-50/30 dark:bg-orange-900/10 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-orange-500 outline-none font-medium text-lg" placeholder="0.00" />
                                                                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">{selectedVault.asset}</span>
                                                                </div>
                                                                <div className="flex justify-between text-xs text-slate-500">
                                                                    <span>Invested {trancheType === 'junior' ? 'Junior' : 'Senior'}: {trancheType === 'junior' ? (selectedVault.balancesJunior?.[userFullAddress] || 0) : (selectedVault.balancesSenior?.[userFullAddress] || 0)} {selectedVault.asset}</span>
                                                                    <span className="text-orange-600 dark:text-orange-400 font-bold cursor-pointer hover:underline" onClick={() => setWithdrawAmount(trancheType === 'junior' ? (selectedVault.balancesJunior?.[userFullAddress] || 0) : (selectedVault.balancesSenior?.[userFullAddress] || 0))}>Max</span>
                                                                </div>
                                                                <button onClick={handleWithdraw} className="w-full py-4 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 hover:border-orange-500 dark:hover:border-orange-500 text-slate-700 dark:text-white hover:text-orange-600 dark:hover:text-orange-400 rounded-xl font-bold transition-all">Withdraw Funds {trancheType}</button>
                                                                <p className="text-xs text-center text-slate-400 mt-2">Withdrawal is permitted free of charge as long as the vault has not started.</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                )
                                            ) : selectedVault.status === 'MATURED' ? (
                                                <div className="space-y-4">
                                                    <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl border border-green-100 dark:border-green-800 mb-4">
                                                        <p className="text-sm text-green-800 dark:text-green-200 font-medium text-center">
                                                            The vault has matured. You can withdraw your earnings.
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => handleClaim(selectedVault)}
                                                        disabled={selectedVault.userBalance <= 0}
                                                        className={`w-full py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg transition-all ${
                                                            selectedVault.userBalance > 0
                                                            ? 'bg-green-600 hover:bg-green-700 text-white shadow-green-200 dark:shadow-none'
                                                            : 'bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Coins className="h-5 w-5" />
                                                        {selectedVault.userBalance > 0 ? "Claim Gains & Principal" : "Gains Claimed"}
                                                    </button>
                                                </div>
                                            ) : selectedVault.status === 'PENDING' ? (
                                                /* --- BLOC POUR PENDING --- */
                                                <div className="space-y-4">
                                                    <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-xl border border-amber-100 dark:border-amber-800 mb-4">
                                                        <div className="flex flex-col items-center text-center">
                                                            <Activity className="h-8 w-8 text-amber-500 mb-2" />
                                                            <p className="text-sm text-amber-800 dark:text-amber-200 font-bold">
                                                                Pending activation
                                                            </p>
                                                            <p className="text-xs text-amber-700 dark:text-amber-300 mt-1">
                                                                This vault is currently being set up by the insurer. Deposits are not yet open.
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <button
                                                        disabled
                                                        className="w-full py-4 rounded-xl font-bold flex justify-center items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500 cursor-not-allowed"
                                                    >
                                                        <Lock className="h-4 w-4" /> Coming soon
                                                    </button>
                                                </div>
                                            ) : (
                                                /* --- BLOC TRIGGERED (CATASTROPHE) --- */
                                                <div className="space-y-4">
                                                    <div className="bg-red-50 dark:bg-red-900/30 p-4 rounded-xl border border-red-100 dark:border-red-800 mb-4">
                                                        <p className="text-sm text-red-800 dark:text-red-200 font-medium text-center">
                                                            Withdrawals are restricted following the event.
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => handleClaim(selectedVault)}
                                                        disabled={selectedVault.userBalance <= 0}
                                                        className={`w-full py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg transition-all ${
                                                            selectedVault.userBalance > 0
                                                            ? 'bg-red-600 hover:bg-red-700 text-white shadow-red-200 dark:shadow-none'
                                                            : 'bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Coins className="h-5 w-5" />
                                                        {selectedVault.userBalance > 0 ? "Claim Remaining Balance" : "Funds Claimed"}
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-5 border border-slate-200 dark:border-slate-700">
                                            <h5 className="font-bold text-slate-900 dark:text-white text-sm mb-3">Need help?</h5>
                                            <ul className="text-sm space-y-2 text-slate-600 dark:text-slate-400">
                                                <li>• <a href="#" className="hover:underline">Whitepaper</a></li>
                                                <li>• <a href="#" className="hover:underline">Smart Contract Audit</a></li>
                                                <li>• <a href="#" className="hover:underline">Discord Support</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        );
                    })()}
                  </div>
                )}

                {/* --- VUE ASSUREUR (COMPLÈTE DE BACKUP_APP) --- */}
                {activeRole === 'insurer' && (
                  <>
                  {/* ETAT 1: WALLET NON CONNECTÉ */}
                  {!walletConnected ? (
                      <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6 animate-in fade-in max-w-2xl mx-auto">
                           <div className="p-6 bg-slate-100 dark:bg-slate-800 rounded-full mb-2">
                               <Shield className="h-20 w-20 text-slate-400 dark:text-slate-500" />
                           </div>
                           <h2 className="text-3xl font-bold text-slate-900 dark:text-white">Insurer Access Only</h2>
                           <p className="text-lg text-slate-500 dark:text-slate-400">
                              The insurer space is restricted to VUSA accredited entities. Please connect your wallet to verify your access rights.
                           </p>
                           <button onClick={openWalletSelector} className="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-blue-200 dark:hover:shadow-none flex items-center gap-2">
                             <Wallet className="h-5 w-5" /> Connect Wallet
                           </button>
                      </div>
                  ) :
                  /* ETAT 2: WALLET CONNECTÉ MAIS PAS SUR LA WHITELIST */
                  !isInsurerWhitelisted ? (
                        <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6 animate-in fade-in max-w-2xl mx-auto">
                           <div className="p-6 bg-red-50 dark:bg-red-900/20 rounded-full mb-2 border border-red-100 dark:border-red-900">
                              <UserCheck className="h-20 w-20 text-red-500 dark:text-red-400" />
                           </div>
                           <h2 className="text-3xl font-bold text-slate-900 dark:text-white">Unauthorized Access</h2>
                           {registrationStatus === 'pending' ? (
                               <div className="mt-4 p-4 bg-amber-50 dark:bg-amber-900/30 rounded-xl border border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-200 max-w-md">
                                   <div className="flex items-center gap-2 font-bold mb-1"><Activity className="h-5 w-5" /> Application under review</div>
                                   <p className="text-sm">Your KYB file has been received and is currently being processed by the protocol team.</p>
                               </div>
                           ) : registrationStatus === 'rejected' ? (
                               <div className="mt-4 p-4 bg-red-50 dark:bg-red-900/30 rounded-xl border border-red-200 dark:border-red-800 text-red-800 dark:text-red-200 max-w-md">
                                   <div className="flex items-center gap-2 font-bold mb-1"><X className="h-5 w-5" /> Application Rejected</div>
                                   <p className="text-sm">Your application has been rejected.</p>
                               </div>
                           ) : (
                               <p className="text-lg text-slate-500 dark:text-slate-400">The address <span className="font-mono font-bold bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">{userAddress}</span> is not certified.</p>
                           )}
                           <div className="flex gap-4 mt-6">
                               <button onClick={disconnectWallet} className="px-6 py-3 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 rounded-xl font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Switch Wallet</button>
                               {registrationStatus !== 'pending' && (
                                   <button onClick={() => setShowInsurerRegistration(true)} className="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-indigo-200 dark:shadow-none">Register as Insurer</button>
                               )}
                           </div>
                      </div>
                  ) :
                  /* ETAT 3: WALLET CONNECTÉ ET WHITELISTÉ -> AFFICHAGE DASHBOARD ASSUREUR */
                  (
                  <div className="flex flex-col lg:flex-row gap-8 animate-in fade-in duration-500">
                    <div className={`transition-all duration-500 ease-in-out min-w-0 ${isFormExpanded ? 'lg:flex-[2]' : 'lg:flex-1'} space-y-6`}>
                      <div
                        className={`bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm transition-all ${isFormExpanded ? 'ring-2 ring-indigo-500/20' : ''}`}
                        onClick={() => setIsFormExpanded(true)}
                        onFocus={() => setIsFormExpanded(true)}
                      >
                        <div className="flex items-center gap-3 mb-6 pb-6 border-b border-slate-100 dark:border-slate-700">
                          <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400"><Plus className="h-5 w-5" /></div>
                          <div><h2 className="text-lg font-bold text-slate-900 dark:text-white">New Vault</h2><p className="text-xs text-slate-500 dark:text-slate-400">Factory Deployment</p></div>
                          {isFormExpanded && (
                              <button onClick={(e) => { e.stopPropagation(); setIsFormExpanded(false); }} className="ml-auto text-xs bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 px-3 py-1.5 rounded-lg text-slate-500 dark:text-slate-400 font-bold flex items-center gap-1 transition-colors"><Minimize2 className="h-3 w-3" /> Collapse</button>
                          )}
                        </div>

                        <form onSubmit={(e) => { handleCreateVault(e); setIsFormExpanded(false); }} className="space-y-4">
                           <div className={isFormExpanded ? "grid grid-cols-2 gap-4" : "space-y-4"}>
                               <div className={isFormExpanded ? "col-span-2" : ""}>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Risk Name</label>
                                <input type="text" value={newVaultData.name} onChange={e => setNewVaultData({...newVaultData, name: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Ex: Florida Wind 2026" />
                              </div>

                              <div className={isFormExpanded ? "grid grid-cols-2 gap-4 col-span-2" : "grid grid-cols-2 gap-4"}>
                                  <div>
                                      <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Blockchain</label>
                                      <select value={newVaultData.chain} onChange={e => setNewVaultData({...newVaultData, chain: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                                          {AVAILABLE_CHAINS.map(chain => (<option key={chain} value={chain}>{chain}</option>))}
                                      </select>
                                  </div>
                                  <div>
                                      <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Asset (Payment)</label>
                                      <select value={newVaultData.asset} onChange={e => setNewVaultData({...newVaultData, asset: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                                          {AVAILABLE_ASSETS.map(asset => (<option key={asset} value={asset}>{asset}</option>))}
                                      </select>
                                  </div>
                              </div>

                              <div className={isFormExpanded ? "col-span-2" : ""}>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Trigger Conditions</label>
                                <textarea value={newVaultData.description} onChange={e => setNewVaultData({...newVaultData, description: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all h-24 resize-none text-sm" placeholder="Conditions..."></textarea>
                              </div>

                              {/* CHAMP DATE DEBUT */}
                              <div className={isFormExpanded ? "col-span-2 p-3 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-800" : "p-3 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-800"}>
                                   <label className="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2"><Calendar className="h-4 w-4"/> Inception Date (Lock)</label>
                                   <div className="grid grid-cols-3 gap-2">
                                        <input type="number" min="1" max="31" value={newVaultData.startDay} onBlur={handleDateBlur} onChange={e => setNewVaultData({...newVaultData, startDay: e.target.value})} className="p-2 rounded-lg border dark:bg-slate-900 dark:border-slate-600" placeholder="DD" />
                                        <select value={newVaultData.startMonth} onBlur={handleDateBlur} onChange={e => setNewVaultData({...newVaultData, startMonth: e.target.value})} className="p-2 rounded-lg border dark:bg-slate-900 dark:border-slate-600">
                                          {MONTHS.map(m => <option key={m.name} value={m.name}>{m.name}</option>)}
                                        </select>
                                        <input type="number" min="2024" value={newVaultData.startYear} onBlur={handleDateBlur} onChange={e => setNewVaultData({...newVaultData, startYear: e.target.value})} className="p-2 rounded-lg border dark:bg-slate-900 dark:border-slate-600" placeholder="YYYY" />
                                   </div>
                               </div>

                              <div className={isFormExpanded ? "grid grid-cols-3 gap-4 col-span-2" : "grid grid-cols-3 gap-4"}>
                                <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">End Day</label><input type="number" min="1" max={getMaxDays(newVaultData.month)} value={newVaultData.day} onBlur={handleDateBlur} onChange={e => setNewVaultData({...newVaultData, day: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="DD" /></div>
                                <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">End Month</label><select value={newVaultData.month} onBlur={handleDateBlur} onChange={e => setNewVaultData({...newVaultData, month: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">{MONTHS.map(m => (<option key={m.name} value={m.name}>{m.name}</option>))}</select></div>
                                <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">End Year</label><input type="number" min={new Date().getFullYear()} value={newVaultData.year} onBlur={handleDateBlur} onChange={e => setNewVaultData({...newVaultData, year: e.target.value})} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="YYYY" /></div>
                              </div>

                              <div className={isFormExpanded ? "grid grid-cols-2 gap-4 col-span-2" : "grid grid-cols-2 gap-4"}>
                                <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Capacity</label><input type="number" min="0" value={newVaultData.cap} onBlur={handleCapBlur} onChange={e => { const val = e.target.value; setNewVaultData({...newVaultData, cap: val, junior: updateJunior(val, newVaultData.juniorPercent)}); }} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                                <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Junior (%)</label><div className="relative"><input type="number" min="0" max="100" value={newVaultData.juniorPercent} onChange={e => { const val = e.target.value; setNewVaultData({...newVaultData, juniorPercent: val, junior: updateJunior(newVaultData.cap, val)}); }} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">%</span></div></div>
                              </div>

                              <div className={isFormExpanded ? "col-span-2" : ""}>
                                  <div className="flex items-center gap-2 mb-2 mt-2">
                                      <input type="checkbox" id="overcollat" checked={isOvercollateralized} onChange={(e) => setIsOvercollateralized(e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-900 cursor-pointer" />
                                      <label htmlFor="overcollat" className="text-sm text-slate-600 dark:text-slate-400 cursor-pointer select-none font-medium">Enable Over-collateralization</label>
                                  </div>
                                  {isOvercollateralized && (
                                      <div className="mb-4 animate-fade-in p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-900">
                                          <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Insured Amount</label>
                                          <div className="relative"><input type="number" min="0" value={newVaultData.coverage} onChange={e => setNewVaultData({...newVaultData, coverage: e.target.value})} className="w-full p-3 border border-blue-200 dark:border-blue-800 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">{newVaultData.asset}</span></div>
                                      </div>
                                  )}
                              </div>

                              <div className={isFormExpanded ? "col-span-2" : ""}>
                                  <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-between items-center text-sm">
                                      <span className="text-slate-500 dark:text-slate-400">Junior Amount Required:</span>
                                      <span className="font-bold text-slate-900 dark:text-white">{formatCurrency(newVaultData.junior)}</span>
                                  </div>
                              </div>

                              <div className={isFormExpanded ? "col-span-2" : ""}>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Premium to Pay</label>
                                <div className="relative"><input type="number" min="0" value={newVaultData.premium} onChange={e => setNewVaultData({...newVaultData, premium: e.target.value})} className="w-full p-3 pl-3 pr-16 border border-green-200 dark:border-green-800 bg-green-50/30 dark:bg-green-900/20 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-green-800 dark:text-green-400 font-medium" /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-green-600 dark:text-green-400 text-xs font-bold">{newVaultData.asset}</span></div>
                              </div>
                          </div>
                          <button type="submit" className="w-full mt-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-3.5 rounded-xl font-bold hover:bg-slate-800 dark:hover:bg-slate-200 transition-all shadow-lg shadow-slate-200 dark:shadow-none">Deploy Contract</button>
                        </form>
                      </div>

                      <div className="bg-indigo-600 dark:bg-indigo-700 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200 dark:shadow-none">
                        <div className="flex items-center gap-3 mb-4"><Shield className="h-6 w-6 opacity-80" /><h3 className="font-bold">VUSA Space</h3></div>
                        <p className="text-indigo-100 text-sm mb-4 leading-relaxed">Your insurer status is verified.</p>
                        <div className="bg-white/10 p-3 rounded-lg backdrop-blur-sm border border-white/10">
                          <div className="flex justify-between text-xs font-mono mb-1"><span className="opacity-70">STATUS</span><span className="text-green-300">VERIFIED</span></div>
                          <div className="flex justify-between text-xs font-mono"><span className="opacity-70">ENTITY</span><span>State Farm Re</span></div>
                        </div>
                      </div>
                    </div>

                    <div className={`transition-all duration-500 ease-in-out min-w-0 ${isFormExpanded ? 'lg:flex-1' : 'lg:flex-[2]'}`} onClick={() => setIsFormExpanded(false)}>
                        <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-6">Your Managed Vaults</h3>
                        <div className="space-y-4">
                        {/* Vérification si la liste est vide */}
                        {(() => {
                            // On filtre les vaults de l'utilisateur
                            const myVaults = vaults.filter(vault =>
                                vault.insurerAddress && vault.insurerAddress.toLowerCase() === userFullAddress.toLowerCase()
                            );

                            // Si aucun vault, on affiche le message d'état vide
                            if (myVaults.length === 0) {
                                return (
                                    <div className="flex flex-col items-center justify-center py-12 px-4 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl bg-slate-50/50 dark:bg-slate-900/30 text-center animate-fade-in group cursor-pointer hover:border-indigo-300 dark:hover:border-indigo-700 transition-colors" onClick={() => setIsFormExpanded(true)}>
                                        <div className="bg-white dark:bg-slate-800 p-4 rounded-full shadow-sm mb-4 group-hover:scale-110 transition-transform duration-300">
                                            <Shield className="h-8 w-8 text-slate-400 dark:text-slate-500 group-hover:text-indigo-500" />
                                        </div>
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white mb-2">No Active Vaults</h4>
                                        <p className="text-sm text-slate-500 dark:text-slate-400 max-w-sm mx-auto mb-6">
                                            You have not deployed an insurance contract yet. Use the form to configure your first parametric product.
                                        </p>
                                        <button
                                            onClick={(e) => { e.stopPropagation(); setIsFormExpanded(true); }}
                                            className="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-bold shadow-sm hover:text-indigo-600 dark:hover:text-indigo-400 hover:border-indigo-200 dark:hover:border-indigo-800 transition-all flex items-center gap-2"
                                        >
                                            <Plus className="h-4 w-4" /> Start Deployment
                                        </button>
                                    </div>
                                );
                            }

                            // 3. Sinon, on affiche la liste normalement (Code existant)
                            return myVaults.map((vault) => (
                            <div key={vault.id} className={`bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 flex flex-col ${!isFormExpanded ? 'md:flex-row' : ''} items-center justify-between gap-6 hover:shadow-md transition-shadow cursor-pointer`}>
                                {isFormExpanded ? (
                                    <div className="flex justify-between items-center w-full">
                                        <div className="min-w-0"><h4 className="font-bold text-slate-900 dark:text-white truncate">{vault.name}</h4><p className="text-xs text-slate-500 dark:text-slate-400 font-mono truncate">{vault.id}</p></div>
                                        <div className="shrink-0 ml-2">
                                            {vault.status === 'PENDING' && <span className="px-2.5 py-1 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 text-xs font-bold rounded-md">PENDING</span>}
                                            {vault.status === 'OPEN' && <span className="px-2.5 py-1 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 text-xs font-bold rounded-md">ACTIVE</span>}
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-2">
                                            <h4 className="text-lg font-bold text-slate-900 dark:text-white">{vault.name}</h4>
                                            {vault.status === 'PENDING' && <span className="px-2.5 py-1 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 text-xs font-bold rounded-md">PENDING</span>}
                                            {vault.status === 'OPEN' && <span className="px-2.5 py-1 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 text-xs font-bold rounded-md">ACTIVE</span>}
                                            {vault.status === 'MATURED' && <span className="px-2.5 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 text-xs font-bold rounded-md">ENDED</span>}
                                        </div>
                                        <div className="flex gap-6 text-sm text-slate-500 dark:text-slate-400">
                                            <span>Capacity: <strong>{formatCurrency(vault.totalCapacity)}</strong></span>
                                            <span>Junior: <strong>{formatCurrency(vault.juniorCapital)}</strong></span>
                                        </div>
                                        </div>

                                        {vault.status === 'PENDING' ? (
                                        <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                                            <div className="text-right">
                                            <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Total to fund (Junior + Premium)</p>
                                            <p className="font-bold text-slate-900 dark:text-white">{formatCurrency(vault.juniorCapital + vault.premium)}</p>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); handleInitializeVault(vault.id); }} className="w-full md:w-auto px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors shadow-sm">Fund & Open</button>
                                        </div>
                                        ) : (
                                        <div className="flex items-center gap-4 bg-slate-50 dark:bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-100 dark:border-slate-700">
                                            <div className="text-right"><p className="text-xs text-slate-400 dark:text-slate-500">Funds Raised</p><p className="font-bold text-slate-700 dark:text-slate-300">{formatCurrency(vault.currentAssets)}</p></div>
                                            <div className="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
                                            <div className="text-right"><p className="text-xs text-slate-400 dark:text-slate-500">Public APR</p><p className="font-bold text-green-600 dark:text-green-400">{vault.apr}%</p></div>
                                        </div>
                                        )}
                                    </>
                                )}
                            </div>
                            ));
                        })()}
                        </div>
                    </div>
                  </div>
                  )}
                  </>
                )}

                {/* --- VUE DASHBOARD --- */}
                {activeRole === 'dashboard' && (
                  !walletConnected ? (
                      <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6 animate-in fade-in max-w-2xl mx-auto">
                           <div className="p-6 bg-slate-100 dark:bg-slate-800 rounded-full mb-2">
                               <Wallet className="h-20 w-20 text-slate-400 dark:text-slate-500" />
                           </div>
                           <h2 className="text-3xl font-bold text-slate-900 dark:text-white">Dashboard Access</h2>
                           <p className="text-lg text-slate-500 dark:text-slate-400">
                              Connect your wallet to view your positions and manage your investments.
                           </p>
                           <button
                             onClick={openWalletSelector}
                             className="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-blue-200 dark:hover:shadow-none flex items-center gap-2"
                           >
                             <Wallet className="h-5 w-5" /> Connect Wallet
                           </button>
                      </div>
                  ) : (
                  <div className="max-w-full mx-auto animate-in fade-in duration-500">
                    <div className="text-center mb-10">
                      <div className="w-20 h-20 bg-green-50 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-100 dark:border-green-800">
                        <Wallet className="h-10 w-10 text-green-600 dark:text-green-400" />
                      </div>
                      <h2 className="text-3xl font-bold text-slate-900 dark:text-white">Portfolio Dashboard</h2>
                      <p className="text-slate-500 dark:text-slate-400 mt-2">Monitor your active investment positions</p>
                    </div>

                    <div className="bg-white dark:bg-slate-800/80 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                      <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <h3 className="font-bold text-slate-800 dark:text-slate-300 flex items-center gap-2">
                          <Activity className="h-4 w-4" /> Active Positions
                        </h3>
                        <span className="flex h-3 w-3 relative">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                      </div>

                      <div className="divide-y divide-slate-100 dark:divide-slate-700">
                          {vaults.filter(v => v.userBalance > 0).map(vault => {

                              // --- CALCULS DES VALEURS ESTIMÉES ET APR PAR TRANCHE ---
                              const userJunior = vault.balancesJunior ? (vault.balancesJunior[userFullAddress] || 0) : 0;
                              const userSenior = vault.balancesSenior ? (vault.balancesSenior[userFullAddress] || 0) : 0;

                              // Appel au Helper
                              const { seniorApr, juniorApr } = getTrancheAprs(vault);

                              // Calcul Temps Restant
                              const daysRemaining = calculateDaysRemaining(vault.maturityDate);
                              const yearFraction = daysRemaining / 365;

                              // Valeurs de Fin Estimées
                              const estimatedSeniorEnd = userSenior * (1 + (seniorApr / 100) * yearFraction);
                              const estimatedJuniorEnd = userJunior * (1 + (juniorApr / 100) * yearFraction);
                              const totalEstimatedEnd = estimatedSeniorEnd + estimatedJuniorEnd;

                              // --- RENDU ---
                              if (vault.status === 'MATURED') {
                              const details = calculatePayoutDetails(vault);
                              return (
                                  <div key={vault.id} className="p-4 bg-green-50/50 dark:bg-green-900/10 relative overflow-hidden">
                                      <div className="flex justify-between items-start mb-6">
                                          <div>
                                              <h4 className="text-xl font-bold text-green-900 dark:text-green-400 flex items-center gap-2">
                                                  <CheckCircle2 className="h-5 w-5" /> {vault.name}
                                              </h4>
                                              <p className="text-xs font-mono text-green-600 dark:text-green-500 mt-1">{vault.id}</p>
                                          </div>
                                          <span className="px-3 py-1 bg-green-100 dark:bg-green-900/50 rounded-full text-xs font-bold text-green-700 dark:text-green-300 border border-green-200 dark:border-green-600">
                                              SUCCESS - CLAIMABLE
                                          </span>
                                      </div>

                                      <div className="bg-white dark:bg-slate-900/50 rounded-xl p-4 border border-green-100 dark:border-green-900/30 mb-6">
                                           <div className="flex justify-between items-center mb-2">
                                              <span className="text-sm text-slate-500 dark:text-slate-400">Initial Balance</span>
                                              <span className="font-mono font-bold text-slate-700 dark:text-slate-300">{formatCurrency(vault.userBalance)}</span>
                                           </div>
                                           <div className="flex justify-between items-center mb-2 text-green-600 dark:text-green-400 text-sm">
                                              <span>Total Gains (Yield)</span>
                                              <span>+ {formatCurrency(details.yieldPayout)}</span>
                                           </div>
                                           <div className="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                                           <div className="flex justify-between items-center">
                                              <span className="font-bold text-slate-900 dark:text-white">Total Available</span>
                                              <span className="font-mono text-xl font-bold text-green-600 dark:text-green-400">{formatCurrency(details.totalPayout)}</span>
                                           </div>
                                      </div>

                                      <button
                                         onClick={() => handleClaim(vault)}
                                         className="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg shadow-green-200 dark:shadow-none transition-all flex justify-center items-center gap-2"
                                      >
                                         <Coins className="h-5 w-5" /> Claim Gains & Capital
                                      </button>
                                  </div>
                              );
                          }

                          // SI LE VAULT EST EN ETAT DE CATASTROPHE (TRIGGERED)
                          if (vault.status === 'TRIGGERED') {
                              const details = calculatePayoutDetails(vault);
                              return (
                                  <div key={vault.id} className="p-8 bg-red-50/50 dark:bg-red-900/10 relative overflow-hidden">
                                      <div className="flex justify-between items-start mb-6">
                                          <div>
                                              <h4 className="text-xl font-bold text-red-900 dark:text-red-400 flex items-center gap-2">
                                                  <AlertTriangle className="h-5 w-5" /> {vault.name}
                                              </h4>
                                              <p className="text-xs font-mono text-red-400 dark:text-red-500 mt-1">{vault.id}</p>
                                          </div>
                                          <span className="px-3 py-1 bg-red-100 dark:bg-red-900/50 rounded-full text-xs font-bold text-red-600 dark:text-red-300 border border-red-200 dark:border-red-600">
                                              LOSS CONFIRMED
                                          </span>
                                      </div>

                                      <div className="bg-white dark:bg-slate-900/50 rounded-xl p-4 border border-red-100 dark:border-red-900/30 mb-6">
                                           <div className="flex justify-between items-center mb-2">
                                              <span className="text-sm text-slate-500 dark:text-slate-400">Initial Balance</span>
                                              <span className="font-mono font-bold text-slate-700 dark:text-slate-300">{formatCurrency(vault.userBalance)}</span>
                                           </div>
                                           <div className="flex justify-between items-center mb-2 text-red-600 dark:text-red-400 text-sm">
                                              <span>Estimated Loss</span>
                                              <span>- {formatCurrency(details.loss)}</span>
                                           </div>
                                           <div className="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                                           <div className="flex justify-between items-center">
                                              <span className="font-bold text-slate-900 dark:text-white">Remaining to Claim</span>
                                              <span className="font-mono text-xl font-bold text-green-600 dark:text-green-400">{formatCurrency(details.totalPayout)}</span>
                                           </div>
                                      </div>

                                      <button
                                         onClick={() => handleClaim(vault)}
                                         className="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-lg shadow-red-200 dark:shadow-none transition-all flex justify-center items-center gap-2"
                                      >
                                         <Coins className="h-5 w-5" /> Claim Remaining Funds
                                      </button>
                                  </div>
                              );
                          }

                          // SINON AFFICHAGE STANDARD (OPEN) AVEC DETAILS JUNIOR/SENIOR
                          return (
                              <details key={vault.id} className="group p-8 open:bg-slate-50 dark:open:bg-slate-900/20 transition-colors duration-300">
                                <summary className="list-none cursor-pointer outline-none [&::-webkit-details-marker]:hidden">
                                    <div className="flex justify-between items-start mb-6">
                                      <div>
                                        <h4 className="text-xl font-bold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{vault.name}</h4>
                                        <p className="text-xs font-mono text-slate-400 dark:text-slate-500 mt-1">{vault.id}</p>
                                      </div>
                                      <div className="flex flex-col items-end gap-1">
                                        <div className="px-3 py-1 bg-green-100 dark:bg-green-900/50 rounded-full text-xs font-bold text-green-600 dark:text-green-300 border border-green-200 dark:border-green-600">
                                            ACTIVE INVESTMENT
                                        </div>
                                        <div className="p-[5px] flex items-center gap-1 text-slate-400 dark:text-slate-500">
                                            <span className="text-xs font-medium">Details</span>
                                            <ChevronDown className="h-4 w-4 transition-transform duration-300 group-open:rotate-180" />
                                        </div>
                                      </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-6">
                                      <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700 group-open:bg-white dark:group-open:bg-slate-800">
                                        <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Invested Amount</p>
                                        <p className="text-2xl font-mono font-bold text-slate-900 dark:text-white">
                                          {formatCurrency(vault.userBalance)} <span className="text-sm font-sans font-normal text-slate-500 dark:text-slate-400">{vault.asset}</span>
                                        </p>
                                      </div>
                                      <div className="bg-white dark:bg-slate-900/30 p-4 rounded-xl border-2 border-green-100 dark:border-green-800 relative overflow-hidden group-open:bg-green-50 dark:group-open:bg-green-900/10">
                                        <div className="absolute top-0 right-0 p-2 opacity-10">
                                          <Coins className="h-16 w-16 text-green-600 dark:text-green-400" />
                                        </div>
                                        <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Estimated Value (Total)</p>
                                        <p className="text-2xl font-mono font-bold text-green-600 dark:text-green-400">
                                          {formatCurrency(totalEstimatedEnd)}
                                        </p>
                                      </div>
                                    </div>
                                </summary>

                                {/* --- SECTION DÉTAILLÉE (EXPANDED) --- */}
                                <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 animate-slide-up">
                                    <h5 className="text-sm font-bold text-slate-900 dark:text-white mb-4">Allocation & Projections by Tranche</h5>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {/* TRANCHE SENIOR */}
                                        <div className="p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/50">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="w-2 h-2 rounded-full bg-blue-500"></span>
                                                <span className="font-bold text-blue-700 dark:text-blue-300 text-sm">Senior Tranche</span>
                                            </div>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-slate-500 dark:text-slate-400">Invested</span>
                                                    <span className="font-mono font-bold text-slate-700 dark:text-slate-200">{formatCurrency(userSenior)}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-slate-500 dark:text-slate-400">Est. APR</span>
                                                    <span className="font-mono font-bold text-blue-600 dark:text-blue-400">{seniorApr.toFixed(2)}%</span>
                                                </div>
                                                <div className="pt-2 mt-2 border-t border-blue-200 dark:border-blue-800/50 flex justify-between text-sm">
                                                    <span className="text-slate-600 dark:text-slate-300 font-medium">Est. End</span>
                                                    <span className="font-mono font-bold text-blue-700 dark:text-blue-300">{formatCurrency(estimatedSeniorEnd)}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* TRANCHE JUNIOR */}
                                        <div className="p-4 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800/50">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="w-2 h-2 rounded-full bg-indigo-500"></span>
                                                <span className="font-bold text-indigo-700 dark:text-indigo-300 text-sm">Junior Tranche</span>
                                            </div>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-slate-500 dark:text-slate-400">Invested</span>
                                                    <span className="font-mono font-bold text-slate-700 dark:text-slate-200">{formatCurrency(userJunior)}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-slate-500 dark:text-slate-400">Est. APR</span>
                                                    <span className="font-mono font-bold text-indigo-600 dark:text-indigo-400">{juniorApr.toFixed(2)}%</span>
                                                </div>
                                                <div className="pt-2 mt-2 border-t border-indigo-200 dark:border-indigo-800/50 flex justify-between text-sm">
                                                    <span className="text-slate-600 dark:text-slate-300 font-medium">Est. End</span>
                                                    <span className="font-mono font-bold text-indigo-700 dark:text-indigo-300">{formatCurrency(estimatedJuniorEnd)}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* RÉSUMÉ TOTAL */}
                                        <div className="p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/50 flex flex-col justify-center">
                                             <div className="text-center">
                                                 <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Estimated Total at Maturity</p>
                                                 <p className="text-2xl font-bold text-green-700 dark:text-green-400 font-mono">{formatCurrency(totalEstimatedEnd)}</p>
                                                 <p className="text-[10px] text-green-600/70 dark:text-green-400/70 mt-1">
                                                     Potential Gain: +{formatCurrency(totalEstimatedEnd - vault.userBalance)}
                                                 </p>
                                             </div>
                                        </div>
                                    </div>

                                    <div className="mt-6 flex justify-end">
                                        <button
                                          onClick={(e) => { e.preventDefault(); setActiveRole('investor'); setSelectedVault(vault); }}
                                          className="px-6 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:border-blue-500 dark:hover:border-blue-500 text-slate-900 dark:text-white rounded-lg font-bold text-sm transition-all shadow-sm hover:shadow flex items-center gap-2"
                                        >
                                          Manage / Adjust Position <ArrowRight className="h-4 w-4" />
                                        </button>
                                    </div>
                                </div>
                              </details>
                          );
                        })}

                        {vaults.filter(v => v.userBalance > 0).length === 0 && (
                          <div className="p-12 text-center">
                            <p className="text-slate-400 dark:text-slate-500 mb-2">No active investments.</p>
                            <button onClick={() => setActiveRole('investor')} className="text-green-600 dark:text-green-400 hover:underline text-sm">
                              Explore opportunities
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  )
                )}

                {/* --- VUE ORACLE --- */}
                {activeRole === 'oracle' && (
                  <div className="max-w-full mx-auto animate-in fade-in duration-500">
                    <div className="text-center mb-10">
                      <div className="w-20 h-20 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-100 dark:border-red-800">
                        <Wind className="h-10 w-10 text-red-600 dark:text-red-400" />
                      </div>
                      <h2 className="text-3xl font-bold text-slate-900 dark:text-white">Oracle Dashboard</h2>
                      <p className="text-slate-500 dark:text-slate-400 mt-2">Parametric trigger monitoring interface</p>
                    </div>

                    <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                      <div className="p-6 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                          <Activity className="h-4 w-4" /> Real-Time Data Feed
                        </h3>
                        <span className="flex h-3 w-3 relative">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                      </div>

                      <div className="divide-y divide-slate-100 dark:divide-slate-700">
                        {vaults.filter(v => v.status === 'OPEN').map(vault => (
                          <div key={vault.id} className="p-8">
                            <div className="flex justify-between items-start mb-6">
                              <div>
                                <h4 className="text-xl font-bold text-slate-900 dark:text-white">{vault.name}</h4>
                                <p className="text-xs font-mono text-slate-400 dark:text-slate-500 mt-1">{vault.id}</p>
                              </div>
                              <div className="flex flex-col items-end gap-1">
                                <div className="px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded-full text-xs font-bold text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600">
                                    MONITORING ACTIVE
                                </div>
                                <span className="text-xs font-medium text-slate-400 dark:text-slate-500">Risk Model: {vault.riskProb}%</span>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-6 mb-8">
                              <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Trigger Threshold</p>
                                <p className="text-2xl font-mono font-bold text-slate-900 dark:text-white">
                                  {vault.triggerValue} <span className="text-sm font-sans font-normal text-slate-500 dark:text-slate-400">units</span>
                                </p>
                              </div>
                              <div className="bg-white dark:bg-slate-900/30 p-4 rounded-xl border-2 border-green-100 dark:border-green-800 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10">
                                  <Activity className="h-16 w-16 text-green-600 dark:text-green-400" />
                                </div>
                                <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Sensor Data (Live)</p>
                                <p className="text-2xl font-mono font-bold text-green-600 dark:text-green-400">
                                  {Math.floor(vault.triggerValue * 0.2)} <span className="text-sm font-sans font-normal text-slate-400 dark:text-slate-500">/ {vault.triggerValue}</span>
                                </p>
                              </div>
                            </div>

                            <div className="border-t border-slate-100 dark:border-slate-700 pt-6">
                              <div className="flex items-center gap-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-xl">
                                <div className="p-2 bg-white dark:bg-slate-800 rounded-full border border-red-100 dark:border-red-900 shadow-sm">
                                  <AlertTriangle className="h-6 w-6 text-red-600 dark:text-red-400" />
                                </div>
                                <div className="flex-1">
                                  <p className="font-bold text-red-900 dark:text-red-300">Test Zone (Simulation)</p>
                                  <p className="text-xs text-red-700 dark:text-red-400">
                                    Simulating a catastrophe sends a `triggerCatastrophe()` transaction to the Smart Contract.
                                  </p>
                                </div>
                                <button
                                  onClick={() => handleTriggerOracle(vault.id)}
                                  className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-lg shadow-red-200 dark:shadow-none transition-all active:scale-95"
                                >
                                  SIMULATE CRASH
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}

                        {vaults.filter(v => v.status === 'OPEN').length === 0 && (
                          <div className="p-12 text-center">
                            <p className="text-slate-400 dark:text-slate-500 mb-2">No active vaults to monitor.</p>
                            <button onClick={() => setActiveRole('insurer')} className="text-blue-600 dark:text-blue-400 hover:underline text-sm">
                              Create a vault as an insurer
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
