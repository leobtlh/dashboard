<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPIV Protocol - Parametric Insurance</title>

    <!-- 1. Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Chargement de React et ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 3. Chargement de Babel pour compiler le JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Animation simple pour le chargement -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Point d'ancrage pour l'application React -->
    <div id="root"></div>

    <!-- 4. Votre code Application -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONSTANTES ---
        const MONTHS = [
            { name: 'Janvier', days: 31 },
            { name: 'F√©vrier', days: 29 },
            { name: 'Mars', days: 31 },
            { name: 'Avril', days: 30 },
            { name: 'Mai', days: 31 },
            { name: 'Juin', days: 30 },
            { name: 'Juillet', days: 31 },
            { name: 'Ao√ªt', days: 31 },
            { name: 'Septembre', days: 30 },
            { name: 'Octobre', days: 31 },
            { name: 'Novembre', days: 30 },
            { name: 'D√©cembre', days: 31 }
        ];

        // --- COMPOSANTS ICONS ---
        const IconWrapper = ({ children, className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" strokeWidth="2"
            strokeLinecap="round" strokeLinejoin="round"
            className={className}
          >
            {children}
          </svg>
        );

        const Shield = ({ className }) => <IconWrapper className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>;
        const Wind = ({ className }) => <IconWrapper className={className}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Activity = ({ className }) => <IconWrapper className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Wallet = ({ className }) => <IconWrapper className={className}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconWrapper>;
        const AlertTriangle = ({ className }) => <IconWrapper className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>;
        const TrendingUp = ({ className }) => <IconWrapper className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
        const Lock = ({ className }) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
        const Plus = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const ArrowRight = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>;
        const CheckCircle2 = ({ className }) => <IconWrapper className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></IconWrapper>;
        const Building2 = ({ className }) => <IconWrapper className={className}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconWrapper>;
        const Coins = ({ className }) => <IconWrapper className={className}><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></IconWrapper>;

        // --- DONN√âES MOCK ---
        const INITIAL_VAULTS = [
          {
            id: "0x742...d439",
            name: "Florida Wind Season 2026",
            insurer: "State Farm Re",
            totalCapacity: 40000000,
            claimAmount: 40000000,
            currentAssets: 4330000,
            juniorCapital: 4000000,
            premium: 330000,
            maturityDate: "18 Jan 2026",
            apr: 25.4,
            riskProb: 12.5,
            status: "OPEN",
            userBalance: 0,
            triggerValue: 250
          },
          {
            id: "0x891...a122",
            name: "Tokyo Earthquake Bond",
            insurer: "Japan Post Insurance",
            totalCapacity: 100000000,
            claimAmount: 100000000,
            currentAssets: 0,
            juniorCapital: 10000000,
            premium: 0,
            maturityDate: "En attente",
            apr: 0,
            riskProb: 4.2,
            status: "PENDING",
            userBalance: 0,
            triggerValue: 7.5
          }
        ];

        // --- APP COMPONENT ---
        function App() {
          const [activeRole, setActiveRole] = useState('investor');
          const [walletConnected, setWalletConnected] = useState(false);
          const [userAddress, setUserAddress] = useState('');
          const [vaults, setVaults] = useState(INITIAL_VAULTS);
          const [selectedVault, setSelectedVault] = useState(null);

          const [depositAmount, setDepositAmount] = useState('');

          // NOUVEL √âTAT √âTENDU POUR LA CR√âATION
          const [newVaultData, setNewVaultData] = useState({
            name: '',
            cap: 40000000,
            coverage: 40000000,
            juniorPercent: 10,
            junior: 4000000,
            premium: 330000,
            day: '',
            month: 'Janvier',
            year: new Date().getFullYear()
          });

          const [isOvercollateralized, setIsOvercollateralized] = useState(false);

          const connectWallet = () => {
            setWalletConnected(true);
            setUserAddress('0x71C...9A23');
          };

          const updateJunior = (cap, percent) => {
             const calculatedJunior = (parseFloat(cap || 0) * parseFloat(percent || 0)) / 100;
             return calculatedJunior;
          };

          const getMaxDays = (monthName) => {
              const m = MONTHS.find(mo => mo.name === monthName);
              return m ? m.days : 31;
          };

          const handleCreateVault = (e) => {
            e.preventDefault();

            const capVal = parseFloat(newVaultData.cap);
            const claimVal = isOvercollateralized ? parseFloat(newVaultData.coverage) : capVal;

            if (capVal <= 0) { alert("Erreur: La capacit√© doit √™tre sup√©rieure √† 0."); return; }
            if (claimVal <= 0) { alert("Erreur: Le montant assur√© doit √™tre sup√©rieur √† 0."); return; }
            if (parseFloat(newVaultData.premium) < 0) { alert("Erreur: La prime ne peut pas √™tre n√©gative."); return; }

            if (!newVaultData.day || !newVaultData.month || !newVaultData.year) {
                alert("Veuillez remplir une date compl√®te.");
                return;
            }

            const monthIndex = MONTHS.findIndex(m => m.name === newVaultData.month);
            const selectedDate = new Date(newVaultData.year, monthIndex, newVaultData.day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate < today) {
                alert("Erreur : La date de maturit√© ne peut pas √™tre dans le pass√©.");
                return;
            }

            const formattedDate = `${newVaultData.day} ${newVaultData.month} ${newVaultData.year}`;
            const simulatedRisk = (Math.random() * 19 + 1).toFixed(1);

            const newVault = {
              id: `0x${Math.floor(Math.random()*10000)}...new`,
              name: newVaultData.name || "Nouveau Cat Bond",
              insurer: "Moi (Assureur)",
              totalCapacity: capVal,
              claimAmount: claimVal,
              currentAssets: 0,
              juniorCapital: parseFloat(newVaultData.junior || 0),
              premium: 0,
              maturityDate: formattedDate,
              apr: 0,
              riskProb: simulatedRisk,
              status: "PENDING",
              userBalance: 0,
              triggerValue: 0
            };
            setVaults([...vaults, newVault]);
            alert(`Smart Contract d√©ploy√© ! Probabilit√© de sinistre estim√©e par le mod√®le: ${simulatedRisk}%`);

            setNewVaultData({
                ...newVaultData,
                name: '',
                day: '',
                month: 'Janvier',
                year: new Date().getFullYear(),
                coverage: capVal
            });
            setIsOvercollateralized(false);
          };

          const handleInitializeVault = (vaultId) => {
            const premiumValue = parseFloat(newVaultData.premium || 0);

            const updatedVaults = vaults.map(v => {
              if (v.id === vaultId) {
                const newCurrentAssets = v.juniorCapital + premiumValue;
                return {
                  ...v,
                  status: "OPEN",
                  premium: premiumValue,
                  currentAssets: newCurrentAssets,
                  apr: ((premiumValue * 100 * 365) / ((v.totalCapacity - v.juniorCapital) * 30)).toFixed(2),
                  maturityDate: v.maturityDate === "En attente" ? new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString() : v.maturityDate
                };
              }
              return v;
            });
            setVaults(updatedVaults);
            alert(`Vault ${vaultId} initialis√© !`);
          };

          const handleDeposit = () => {
            if (!selectedVault || !depositAmount) return;
            const amount = parseFloat(depositAmount);
            if (amount <= 0) {
                alert("Erreur : Le montant de l'investissement doit √™tre strictement positif.");
                return;
            }
            const updatedVaults = vaults.map(v => {
              if (v.id === selectedVault.id) {
                return {
                  ...v,
                  currentAssets: v.currentAssets + amount,
                  userBalance: v.userBalance + amount // Simulation du d√©p√¥t user
                };
              }
              return v;
            });
            setVaults(updatedVaults);
            alert(`D√©p√¥t de ${formatCurrency(amount)} confirm√© sur la blockchain !`);
            setDepositAmount('');
            setSelectedVault(null);
          };

          const handleTriggerOracle = (vaultId) => {
            const updatedVaults = vaults.map(v => {
              if (v.id === vaultId) {
                return { ...v, status: "TRIGGERED" };
              }
              return v;
            });
            setVaults(updatedVaults);
            alert("‚ö†Ô∏è ORACLE ALERT : Catastrophe valid√©e. Soft Default activ√©.");
          };

          // --- LOGIQUE DE R√âCLAMATION (CLAIM) ---
          const calculateClaimStats = (vault) => {
              // 1. D√©finir les masses
              const totalFunds = vault.currentAssets; // Tout l'argent dans le coffre (Junior + Senior + Yield)
              const junior = vault.juniorCapital;

              // On suppose que le Senior est le reste (simplification pour la d√©mo)
              const senior = Math.max(0, totalFunds - junior);

              // 2. Calculer le besoin de l'assureur
              const claimNeeded = vault.claimAmount || vault.totalCapacity;

              // 3. Waterfall : Qui paie quoi ?
              // Junior paie en premier
              const juniorPayout = Math.min(junior, claimNeeded);
              const remainingClaim = claimNeeded - juniorPayout;

              // Senior paie le reste
              const seniorPayout = Math.min(senior, remainingClaim);

              // 4. Ce qu'il reste pour les investisseurs (Senior)
              const seniorRemaining = Math.max(0, senior - seniorPayout);

              // 5. Ratio de r√©cup√©ration du principal
              // Si senior √©tait 0 (pas d'investisseurs), ratio 0. Sinon part restante / part initiale
              const recoveryRatio = senior > 0 ? (seniorRemaining / senior) : 0;

              return { recoveryRatio, seniorRemaining };
          };

          const handleClaim = (vault) => {
              const { recoveryRatio } = calculateClaimStats(vault);
              const principalRecovered = vault.userBalance * recoveryRatio;
              const yieldBonus = vault.userBalance * 0.05; // 5% APR fixe demand√©
              const totalPayout = principalRecovered + yieldBonus;

              alert(`R√©clamation r√©ussie !\n\nVous avez r√©cup√©r√© : ${formatCurrency(totalPayout)}\n(Dont 5% de Yield garanti)`);

              // Reset user balance visually
              const updatedVaults = vaults.map(v => {
                  if (v.id === vault.id) return { ...v, userBalance: 0 };
                  return v;
              });
              setVaults(updatedVaults);
          };

          const formatCurrency = (val) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
          };

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 font-sans animate-fade-in">

              {/* NAVBAR */}
              <nav className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between h-16 items-center">
                    <div className="flex items-center gap-2">
                      <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-2 rounded-lg text-white">
                        <Shield className="h-6 w-6" />
                      </div>
                      <span className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-600">
                        HPIV MOEBA Protocol
                      </span>
                    </div>

                    <div className="flex items-center gap-4">
                      <div className="hidden md:flex bg-slate-100 rounded-lg p-1">
                        <button
                          onClick={() => setActiveRole('investor')}
                          className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'investor' ? 'bg-white shadow-sm text-blue-700' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                          Investisseur
                        </button>
                        <button
                          onClick={() => setActiveRole('insurer')}
                          className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'insurer' ? 'bg-white shadow-sm text-indigo-700' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                          Assureur
                        </button>
                        <button
                          onClick={() => setActiveRole('oracle')}
                          className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'oracle' ? 'bg-white shadow-sm text-red-600' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                          Oracle
                        </button>
                      </div>

                      <button
                        onClick={connectWallet}
                        className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-colors border ${walletConnected ? 'bg-green-50 text-green-700 border-green-200' : 'bg-slate-900 text-white hover:bg-slate-800 border-transparent'}`}
                      >
                        <Wallet className="h-4 w-4" />
                        {walletConnected ? userAddress : "Connecter Wallet"}
                      </button>
                    </div>
                  </div>
                </div>
              </nav>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

                {/* STATS GLOBALES */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                  <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start">
                      <div>
                        <p className="text-sm font-medium text-slate-500">Total Value Locked (TVL)</p>
                        <h3 className="text-3xl font-bold text-slate-900 mt-2">$44.3M</h3>
                      </div>
                      <div className="p-3 bg-blue-50 rounded-xl">
                        <Activity className="h-6 w-6 text-blue-600" />
                      </div>
                    </div>
                    <div className="mt-4 flex items-center text-sm text-green-600 bg-green-50 w-fit px-2 py-1 rounded-full">
                      <TrendingUp className="h-3 w-3 mr-1" /> +2.4% this week
                    </div>
                  </div>

                  <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start">
                      <div>
                        <p className="text-sm font-medium text-slate-500">Rendement Moyen (APR)</p>
                        <h3 className="text-3xl font-bold text-slate-900 mt-2">18.5%</h3>
                      </div>
                      <div className="p-3 bg-green-50 rounded-xl">
                        <TrendingUp className="h-6 w-6 text-green-600" />
                      </div>
                    </div>
                    <div className="mt-4 text-sm text-slate-500">
                      Boost√© par les primes d'assurance
                    </div>
                  </div>

                  <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start">
                      <div>
                        <p className="text-sm font-medium text-slate-500">Capital S√©curis√©</p>
                        <h3 className="text-3xl font-bold text-slate-900 mt-2">100%</h3>
                      </div>
                      <div className="p-3 bg-indigo-50 rounded-xl">
                        <Lock className="h-6 w-6 text-indigo-600" />
                      </div>
                    </div>
                    <div className="mt-4 text-sm text-slate-500">
                      Mod√®le Fully Funded (VUSA)
                    </div>
                  </div>
                </div>

                {/* --- VUE INVESTISSEUR --- */}
                {activeRole === 'investor' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-end">
                      <div>
                        <h2 className="text-2xl font-bold text-slate-900">Opportunit√©s de Vaults</h2>
                        <p className="text-slate-500 mt-1">Investissez dans des risques param√©triques s√©curis√©s par la blockchain.</p>
                      </div>
                      <div className="text-sm font-medium text-blue-600 bg-blue-50 px-4 py-2 rounded-full flex items-center gap-2">
                        <Shield className="h-4 w-4" /> Audit√© & R√©gul√©
                      </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {vaults.map((vault) => (
                        <div key={vault.id} className={`group relative bg-white rounded-2xl border transition-all ${vault.status === 'TRIGGERED' ? 'border-red-200 bg-red-50/50' : 'border-slate-200 hover:border-blue-300 hover:shadow-lg'}`}>
                          {/* Badge Status */}
                          <div className="absolute top-6 right-6">
                            {vault.status === 'OPEN' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 flex items-center gap-1"><CheckCircle2 className="h-3 w-3" /> OPEN</span>}
                            {vault.status === 'PENDING' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 flex items-center gap-1"><Activity className="h-3 w-3" /> PENDING</span>}
                            {vault.status === 'TRIGGERED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 flex items-center gap-1"><AlertTriangle className="h-3 w-3" /> CATASTROPHE</span>}
                          </div>

                          <div className="p-8">
                            <div className="mb-6">
                              <h3 className="text-xl font-bold text-slate-900 group-hover:text-blue-600 transition-colors">{vault.name}</h3>
                              <p className="text-sm text-slate-500 mt-1 flex items-center gap-2">
                                <Building2 className="h-3 w-3" /> Assureur: {vault.insurer}
                              </p>
                            </div>

                            <div className="flex justify-between items-end mb-6">
                              <div>
                                <p className="text-sm text-slate-500 mb-1">Rendement (APR)</p>
                                <p className={`text-4xl font-bold ${vault.status === 'OPEN' ? 'text-green-600' : 'text-slate-400'}`}>
                                  {vault.apr}%
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-sm text-slate-500 mb-1">Lev√©e de Fonds</p>
                                <p className="text-lg font-semibold text-slate-900">
                                  {formatCurrency(vault.currentAssets)} <span className="text-slate-400 text-sm font-normal">/ {formatCurrency(vault.totalCapacity)}</span>
                                </p>
                              </div>
                            </div>

                            {/* AFFICHAGE DU RISQUE */}
                            <div className="flex justify-between items-center mb-3">
                                <span className="text-sm font-medium text-slate-500 flex items-center gap-1">
                                    <AlertTriangle className="h-3 w-3 text-orange-500" /> Probabilit√© de sinistre
                                </span>
                                <span className={`text-sm font-bold ${vault.riskProb > 10 ? 'text-red-600' : 'text-orange-500'}`}>
                                    {vault.riskProb}%
                                </span>
                            </div>

                            {/* Progress Bar */}
                            <div className="w-full bg-slate-100 rounded-full h-3 mb-6 overflow-hidden">
                              <div
                                className={`h-full rounded-full transition-all duration-1000 ${vault.status === 'TRIGGERED' ? 'bg-red-500' : 'bg-blue-600'}`}
                                style={{ width: `${(vault.currentAssets / vault.totalCapacity) * 100}%` }}
                              ></div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                              <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <p className="text-slate-500 text-xs uppercase tracking-wider mb-1">Protection Junior</p>
                                <p className="font-semibold text-slate-900">{formatCurrency(vault.juniorCapital)}</p>
                              </div>
                              <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <p className="text-slate-500 text-xs uppercase tracking-wider mb-1">Maturit√©</p>
                                <p className="font-semibold text-slate-900">{vault.maturityDate}</p>
                              </div>
                            </div>

                            {/* AFFICHAGE CONDITIONNEL: SUR-COLLAT√âRALISATION */}
                            {vault.totalCapacity > (vault.claimAmount || vault.totalCapacity) && (
                                <div className="mb-6 p-3 bg-green-50 border border-green-100 rounded-lg flex items-center gap-3">
                                    <Shield className="h-5 w-5 text-green-600" />
                                    <div>
                                        <p className="text-xs font-bold text-green-800 uppercase">Sur-collat√©ralis√©</p>
                                        <p className="text-xs text-green-700">
                                            Couverture Max: <strong>{formatCurrency(vault.claimAmount)}</strong>
                                        </p>
                                    </div>
                                </div>
                            )}

                            {vault.status === 'OPEN' ? (
                              <button
                                onClick={() => setSelectedVault(vault)}
                                className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-medium hover:bg-blue-600 hover:shadow-lg hover:-translate-y-0.5 transition-all flex justify-center items-center gap-2"
                              >
                                Investir Maintenant <ArrowRight className="h-4 w-4" />
                              </button>
                            ) : vault.status === 'TRIGGERED' ? (
                                <div className="space-y-3">
                                    <div className="bg-red-50 p-3 rounded-xl border border-red-100 text-sm">
                                        <p className="font-bold text-red-800 mb-1">üö® Catastrophe Confirm√©e</p>
                                        <div className="flex justify-between text-red-700 text-xs">
                                            <span>Capital Sauv√© (Sur-collat):</span>
                                            <span className="font-mono">{(calculateClaimStats(vault).recoveryRatio * 100).toFixed(1)}%</span>
                                        </div>
                                        <div className="flex justify-between text-green-700 text-xs mt-1">
                                            <span>Yield S√©curis√©:</span>
                                            <span className="font-mono">+5.0%</span>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => handleClaim(vault)}
                                        disabled={vault.userBalance <= 0}
                                        className={`w-full py-3.5 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg transition-all ${
                                            vault.userBalance > 0
                                            ? 'bg-green-600 text-white hover:bg-green-700 shadow-green-200'
                                            : 'bg-slate-100 text-slate-400 cursor-not-allowed'
                                        }`}
                                    >
                                        <Coins className="h-5 w-5" />
                                        {vault.userBalance > 0 ? "R√©clamer Fonds Restants" : "Aucun solde √† r√©clamer"}
                                    </button>
                                </div>
                            ) : (
                              <button disabled className="w-full bg-slate-100 text-slate-400 py-3.5 rounded-xl font-medium cursor-not-allowed">
                                {vault.status === 'PENDING' ? 'En attente d\'ouverture' : 'Investissements Ferm√©s'}
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* MODALE DE D√âP√îT */}
                    {selectedVault && (
                      <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                        <div className="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl transform transition-all scale-100">
                          <div className="flex justify-between items-start mb-6">
                            <h3 className="text-2xl font-bold text-slate-900">Investir</h3>
                            <button onClick={() => setSelectedVault(null)} className="text-slate-400 hover:text-slate-600">‚úï</button>
                          </div>

                          <div className="bg-blue-50 border border-blue-100 p-4 rounded-xl mb-6">
                            <div className="flex gap-3">
                              <AlertTriangle className="h-5 w-5 text-blue-600 shrink-0" />
                              <div>
                                <p className="text-sm font-bold text-blue-900 mb-1">Profil de Risque</p>
                                <p className="text-xs text-blue-700 leading-relaxed">
                                  En investissant dans {selectedVault.name}, vous acceptez une probabilit√© de sinistre de <strong>{selectedVault.riskProb}%</strong>. En contrepartie, vous visez un rendement de {selectedVault.apr}%.
                                </p>
                              </div>
                            </div>
                          </div>

                          <div className="space-y-4 mb-8">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-2">Montant √† d√©poser (USDC)</label>
                              <div className="relative">
                                <input
                                  type="number"
                                  min="0"
                                  step="0.01"
                                  value={depositAmount}
                                  onChange={(e) => setDepositAmount(e.target.value)}
                                  className="w-full pl-4 pr-16 py-3.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium text-lg"
                                  placeholder="0.00"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">USDC</span>
                              </div>
                            </div>
                            <div className="flex justify-between text-sm text-slate-500 px-1">
                              <span>Solde disponible:</span>
                              <span>50,000.00 USDC</span>
                            </div>
                          </div>

                          <div className="flex gap-3">
                            <button
                              onClick={() => setSelectedVault(null)}
                              className="flex-1 px-4 py-3.5 border border-slate-200 text-slate-700 font-medium hover:bg-slate-50 rounded-xl transition-colors"
                            >
                              Annuler
                            </button>
                            <button
                              onClick={handleDeposit}
                              className="flex-[2] bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all"
                            >
                              Confirmer
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* --- VUE ASSUREUR --- */}
                {activeRole === 'insurer' && (
                  <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-500">
                    {/* Sidebar cr√©ation */}
                    <div className="lg:col-span-4 space-y-6">
                      <div className="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <div className="flex items-center gap-3 mb-6 pb-6 border-b border-slate-100">
                          <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                            <Plus className="h-5 w-5" />
                          </div>
                          <div>
                            <h2 className="text-lg font-bold text-slate-900">Nouveau Vault</h2>
                            <p className="text-xs text-slate-500">D√©ploiement Factory</p>
                          </div>
                        </div>

                        <form onSubmit={handleCreateVault} className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1.5">Nom du Risque</label>
                            <input
                              type="text"
                              value={newVaultData.name}
                              onChange={e => setNewVaultData({...newVaultData, name: e.target.value})}
                              className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                              placeholder="Ex: Florida Wind 2026"
                            />
                          </div>

                          {/* S√âLECTEUR DE DATE */}
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1.5">Jour</label>
                              <input
                                type="number"
                                min="1"
                                max={getMaxDays(newVaultData.month)}
                                value={newVaultData.day}
                                onChange={e => {
                                    let val = parseInt(e.target.value);
                                    if(val > getMaxDays(newVaultData.month)) val = getMaxDays(newVaultData.month);
                                    if(val < 1) val = ''; // Permettre de vider le champ
                                    setNewVaultData({...newVaultData, day: val});
                                }}
                                className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="JJ"
                              />
                            </div>
                            <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1.5">Mois</label>
                            <select
                                value={newVaultData.month}
                                onChange={e => {
                                    const newMonth = e.target.value;
                                    const maxDays = getMaxDays(newMonth);
                                    let currentDay = newVaultData.day;
                                    // Ajuster le jour si n√©cessaire
                                    if (currentDay > maxDays) currentDay = maxDays;

                                    setNewVaultData({...newVaultData, month: newMonth, day: currentDay});
                                }}
                                className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all bg-white"
                            >
                                {MONTHS.map(m => (
                                    <option key={m.name} value={m.name}>{m.name}</option>
                                ))}
                            </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1.5">Ann√©e</label>
                              <input
                                type="number"
                                min={new Date().getFullYear()}
                                value={newVaultData.year}
                                onChange={e => setNewVaultData({...newVaultData, year: e.target.value})}
                                className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="AAAA"
                              />
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1.5">Capacit√© (USDC)</label>
                              <input
                                type="number"
                                min="0"
                                value={newVaultData.cap}
                                onChange={e => {
                                    const val = e.target.value;
                                    setNewVaultData({
                                        ...newVaultData,
                                        cap: val,
                                        junior: updateJunior(val, newVaultData.juniorPercent)
                                    });
                                }}
                                className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1.5">Junior (%)</label>
                              <div className="relative">
                                <input
                                    type="number"
                                    min="0"
                                    max="100"
                                    value={newVaultData.juniorPercent}
                                    onChange={e => {
                                        const val = e.target.value;
                                        setNewVaultData({
                                            ...newVaultData,
                                            juniorPercent: val,
                                            junior: updateJunior(newVaultData.cap, val)
                                        });
                                    }}
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">%</span>
                              </div>
                            </div>
                          </div>

                          {/* OPTION DE SUR-COLLAT√âRALISATION */}
                          <div className="flex items-center gap-2 mb-2 mt-2">
                              <input
                                type="checkbox"
                                id="overcollat"
                                checked={isOvercollateralized}
                                onChange={(e) => setIsOvercollateralized(e.target.checked)}
                                className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer"
                              />
                              <label htmlFor="overcollat" className="text-sm text-slate-600 cursor-pointer select-none font-medium">
                                  Activer la Sur-collat√©ralisation
                              </label>
                          </div>

                          {isOvercollateralized && (
                              <div className="mb-4 animate-fade-in p-3 bg-blue-50 rounded-xl border border-blue-100">
                                  <label className="block text-sm font-medium text-slate-700 mb-1.5">Montant Assur√© (Claim Amount)</label>
                                  <div className="relative">
                                    <input
                                        type="number"
                                        min="0"
                                        value={newVaultData.coverage}
                                        onChange={e => setNewVaultData({...newVaultData, coverage: e.target.value})}
                                        className="w-full p-3 border border-blue-200 bg-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">USDC</span>
                                  </div>
                                  <p className="text-xs text-slate-500 mt-2">
                                      Ce montant est celui qui sera r√©ellement couvert en cas de sinistre. Il peut √™tre inf√©rieur √† la capacit√© lev√©e (sur-collat√©ralisation).
                                  </p>
                              </div>
                          )}

                          {/* Affichage du Montant Junior Calcul√© */}
                          <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 flex justify-between items-center text-sm">
                              <span className="text-slate-500">Montant Junior requis:</span>
                              <span className="font-bold text-slate-900">{formatCurrency(newVaultData.junior)}</span>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1.5">Prime √† Payer (Yield Boost)</label>
                            <div className="relative">
                              <input
                                type="number"
                                min="0"
                                value={newVaultData.premium}
                                onChange={e => setNewVaultData({...newVaultData, premium: e.target.value})}
                                className="w-full p-3 pl-3 pr-16 border border-green-200 bg-green-50/30 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-green-800 font-medium"
                              />
                              <span className="absolute right-4 top-1/2 -translate-y-1/2 text-green-600 text-xs font-bold">USDC</span>
                            </div>
                            <p className="text-xs text-slate-500 mt-2">
                              Montant vers√© imm√©diatement pour booster l'APR des investisseurs.
                            </p>
                          </div>

                          <button type="submit" className="w-full mt-4 bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg shadow-slate-200">
                            D√©ployer le Contrat
                          </button>
                        </form>
                      </div>

                      {/* Status Card */}
                      <div className="bg-indigo-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200">
                        <div className="flex items-center gap-3 mb-4">
                          <Shield className="h-6 w-6 opacity-80" />
                          <h3 className="font-bold">Espace VUSA</h3>
                        </div>
                        <p className="text-indigo-100 text-sm mb-4 leading-relaxed">
                          Votre statut d'assureur est v√©rifi√© (Whitelist). Vos fonds Junior Tranche sont verrouill√©s en "First Loss" jusqu'√† maturit√©.
                        </p>
                        <div className="bg-white/10 p-3 rounded-lg backdrop-blur-sm border border-white/10">
                          <div className="flex justify-between text-xs font-mono mb-1">
                            <span className="opacity-70">STATUS</span>
                            <span className="text-green-300">VERIFIED</span>
                          </div>
                          <div className="flex justify-between text-xs font-mono">
                            <span className="opacity-70">ENTITY</span>
                            <span>State Farm Re</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Main content Assureur */}
                    <div className="lg:col-span-8">
                      <h3 className="text-xl font-bold text-slate-900 mb-6">Vos Vaults G√©r√©s</h3>

                      <div className="space-y-4">
                        {vaults.map((vault) => (
                          <div key={vault.id} className="bg-white border border-slate-200 rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-6 hover:shadow-md transition-shadow">
                            <div className="flex-1">
                              <div className="flex items-center gap-3 mb-2">
                                <h4 className="text-lg font-bold text-slate-900">{vault.name}</h4>
                                {vault.status === 'PENDING' && <span className="px-2.5 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded-md">PENDING</span>}
                                {vault.status === 'OPEN' && <span className="px-2.5 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-md">ACTIVE</span>}
                              </div>
                              <div className="flex gap-6 text-sm text-slate-500">
                                <span>Capacit√©: <strong>{formatCurrency(vault.totalCapacity)}</strong></span>
                                <span>Junior: <strong>{formatCurrency(vault.juniorCapital)}</strong></span>
                              </div>
                              {/* Affichage Claim Amount si diff√©rent */}
                              {vault.totalCapacity > (vault.claimAmount || vault.totalCapacity) && (
                                  <div className="mt-2 text-xs text-green-700 font-medium bg-green-50 inline-block px-2 py-1 rounded">
                                      Couverture Max: {formatCurrency(vault.claimAmount)} (Sur-collat√©ralis√©)
                                  </div>
                              )}
                            </div>

                            {vault.status === 'PENDING' ? (
                              <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                                <div className="text-right">
                                  <p className="text-xs text-slate-500 mb-1">Total √† financer (Junior + Prime)</p>
                                  <p className="font-bold text-slate-900">{formatCurrency(vault.juniorCapital + vault.premium)}</p>
                                </div>
                                <button
                                  onClick={() => handleInitializeVault(vault.id)}
                                  className="w-full md:w-auto px-6 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors shadow-sm"
                                >
                                  Financer & Ouvrir
                                </button>
                              </div>
                            ) : (
                              <div className="flex items-center gap-4 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
                                <div className="text-right">
                                  <p className="text-xs text-slate-400">Fonds lev√©s</p>
                                  <p className="font-bold text-slate-700">{formatCurrency(vault.currentAssets)}</p>
                                </div>
                                <div className="h-8 w-px bg-slate-200"></div>
                                <div className="text-right">
                                  <p className="text-xs text-slate-400">APR Public</p>
                                  <p className="font-bold text-green-600">{vault.apr}%</p>
                                </div>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* --- VUE ORACLE --- */}
                {activeRole === 'oracle' && (
                  <div className="max-w-3xl mx-auto animate-in fade-in duration-500">
                    <div className="text-center mb-10">
                      <div className="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-100">
                        <Wind className="h-10 w-10 text-red-600" />
                      </div>
                      <h2 className="text-3xl font-bold text-slate-900">Oracle Dashboard</h2>
                      <p className="text-slate-500 mt-2">Interface de surveillance des triggers param√©triques</p>
                    </div>

                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                      <div className="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                          <Activity className="h-4 w-4" /> Flux de Donn√©es en Temps R√©el
                        </h3>
                        <span className="flex h-3 w-3 relative">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                      </div>

                      <div className="divide-y divide-slate-100">
                        {vaults.filter(v => v.status === 'OPEN').map(vault => (
                          <div key={vault.id} className="p-8">
                            <div className="flex justify-between items-start mb-6">
                              <div>
                                <h4 className="text-xl font-bold text-slate-900">{vault.name}</h4>
                                <p className="text-xs font-mono text-slate-400 mt-1">{vault.id}</p>
                              </div>
                              <div className="flex flex-col items-end gap-1">
                                <div className="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-600 border border-slate-200">
                                    MONITORING ACTIVE
                                </div>
                                <span className="text-xs font-medium text-slate-400">Mod√®le de Risque: {vault.riskProb}%</span>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-6 mb-8">
                              <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <p className="text-xs text-slate-500 uppercase tracking-wider mb-2">Seuil de D√©clenchement</p>
                                <p className="text-2xl font-mono font-bold text-slate-900">
                                  {vault.triggerValue} <span className="text-sm font-sans font-normal text-slate-500">unit√©s</span>
                                </p>
                              </div>
                              <div className="bg-white p-4 rounded-xl border-2 border-green-100 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10">
                                  <Activity className="h-16 w-16 text-green-600" />
                                </div>
                                <p className="text-xs text-slate-500 uppercase tracking-wider mb-2">Donn√©e Capteur (Live)</p>
                                <p className="text-2xl font-mono font-bold text-green-600">
                                  {Math.floor(vault.triggerValue * 0.2)} <span className="text-sm font-sans font-normal text-slate-400">/ {vault.triggerValue}</span>
                                </p>
                              </div>
                            </div>

                            <div className="border-t border-slate-100 pt-6">
                              <div className="flex items-center gap-4 p-4 bg-red-50 border border-red-100 rounded-xl">
                                <div className="p-2 bg-white rounded-full border border-red-100 shadow-sm">
                                  <AlertTriangle className="h-6 w-6 text-red-600" />
                                </div>
                                <div className="flex-1">
                                  <p className="font-bold text-red-900">Zone de Test (Simulation)</p>
                                  <p className="text-xs text-red-700">
                                    Simuler une catastrophe envoie une transaction `triggerCatastrophe()` au Smart Contract.
                                  </p>
                                </div>
                                <button
                                  onClick={() => handleTriggerOracle(vault.id)}
                                  className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-lg shadow-red-200 transition-all active:scale-95"
                                >
                                  SIMULER CRASH
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}

                        {vaults.filter(v => v.status === 'OPEN').length === 0 && (
                          <div className="p-12 text-center">
                            <p className="text-slate-400 mb-2">Aucun vault actif √† surveiller.</p>
                            <button onClick={() => setActiveRole('insurer')} className="text-blue-600 hover:underline text-sm">
                              Cr√©er un vault en tant qu'assureur
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

              </main>
            </div>
          );
        }

        // Initialisation React 18
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
